<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<title>Cupcakes on the Avenue Admin Dashboard</title>
<link rel="icon" type="image/x-icon" href="pictures/favicon.ico">

<!-- PWA Meta Tags -->
<meta name="description" content="Professional admin dashboard for Cupcakes on the Avenue - manage orders, customers, inventory, and communications">
<meta name="keywords" content="admin, dashboard, bakery, cupcakes, management">
<meta name="author" content="Cupcakes on the Avenue">
<meta name="theme-color" content="#667eea">
<meta name="msapplication-TileColor" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="COTA Admin">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="Cupcakes on the Avenue Admin">

<!-- PWA Manifest -->
<link rel="manifest" href="admin-manifest.json">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="pictures/logo.png">

<!-- Microsoft Tiles -->
<meta name="msapplication-TileImage" content="pictures/logo.png">
<meta name="msapplication-config" content="browserconfig.xml">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: #333;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  /* PWA enhancements */
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
  /* Safe area for notched devices */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

/* Login Screen */
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
}

.login-box {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  max-width: 400px;
  width: 100%;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.login-box h1 {
  color: #667eea;
  margin-bottom: 30px;
  font-size: 2rem;
}

.login-box input {
  width: 100%;
  padding: 15px;
  margin: 10px 0;
  border: 2px solid rgba(102, 126, 234, 0.2);
  border-radius: 10px;
  font-size: 1rem;
  background: rgba(255, 255, 255, 0.8);
}

.login-box input:focus {
  border-color: #667eea;
  outline: none;
  background: white;
}

.login-btn {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
  transition: transform 0.2s ease;
}

.login-btn:hover {
  transform: translateY(-2px);
}

.error-message {
  color: #dc3545;
  margin-top: 10px;
  font-size: 0.9rem;
}

/* Dashboard */
.dashboard {
  display: none;
  padding: 20px;
  max-width: 1600px;
  margin: 0 auto;
}

.dashboard-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 30px;
  border-radius: 20px;
  margin-bottom: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.dashboard-header h1 {
  color: #667eea;
  font-size: 2.5rem;
}

.header-controls {
  display: flex;
  gap: 15px;
  align-items: center;
}

.logout-btn, .refresh-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.refresh-btn {
  background: #28a745;
}

.logout-btn:hover, .refresh-btn:hover {
  transform: translateY(-2px);
}

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  padding: 10px;
  margin-bottom: 30px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  border: 1px solid rgba(255, 255, 255, 0.3);
  overflow-x: auto;
  gap: 5px;
  flex-wrap: nowrap;
  -webkit-overflow-scrolling: touch;
}

.nav-tabs::-webkit-scrollbar {
  height: 4px;
}

.nav-tabs::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.1);
  border-radius: 2px;
}

.nav-tabs::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 2px;
}

.nav-tab {
  background: transparent;
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: #667eea;
  transition: all 0.3s ease;
  white-space: nowrap;
  min-width: fit-content;
}

.nav-tab.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  transform: translateY(-2px);
}

.nav-tab:hover:not(.active) {
  background: rgba(102, 126, 234, 0.1);
}

/* Tab Content */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Dashboard Cards */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
  margin-bottom: 30px;
}

.dashboard-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  border: 1px solid rgba(255, 255, 255, 0.3);
  transition: transform 0.3s ease;
}

.dashboard-card:hover {
  transform: translateY(-5px);
}

.dashboard-card h2 {
  color: #667eea;
  margin-bottom: 20px;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(240, 240, 240, 0.5);
}

.stat-item:last-child {
  border-bottom: none;
}

.stat-value {
  font-weight: bold;
  color: #667eea;
  font-size: 1.1rem;
}

/* Charts */
.chart-container {
  position: relative;
  height: 300px;
  margin-top: 20px;
}

/* Tables */
.table-container {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  border: 1px solid rgba(255, 255, 255, 0.3);
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.data-table th,
.data-table td {
  padding: 15px;
  text-align: left;
  border-bottom: 1px solid rgba(240, 240, 240, 0.5);
}

.data-table th {
  background: rgba(102, 126, 234, 0.1);
  font-weight: bold;
  color: #667eea;
  position: sticky;
  top: 0;
}

.activity-item {
  border-left: 4px solid #667eea;
  padding: 12px;
  margin-bottom: 10px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
}

.activity-item:hover {
  transform: translateX(5px);
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(240, 240, 240, 0.5);
}

.stat-label {
  font-weight: 500;
  color: #666;
}

.stat-value {
  font-weight: bold;
  color: #667eea;
  font-size: 1.2em;
}

.user-info {
  display: flex;
  align-items: center;
  margin-right: 15px;
  padding: 8px 15px;
  background: rgba(255,255,255,0.1);
  border-radius: 20px;
  font-size: 14px;
  color: white;
}

.data-table tr:hover {
  background: rgba(102, 126, 234, 0.05);
}

/* Status Badges */
.status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
  text-transform: uppercase;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-confirmed { background: #d4edda; color: #155724; }
.status-completed { background: #cce5ff; color: #004085; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.status-paid { background: #d1ecf1; color: #0c5460; }
.status-unpaid { background: #ffeaa7; color: #856404; }

/* Action Buttons */
.action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: bold;
  margin: 2px;
  transition: all 0.2s ease;
}

.btn-primary { background: #007bff; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-danger { background: #dc3545; color: white; }
.btn-info { background: #17a2b8; color: white; }

.action-btn:hover {
  transform: translateY(-1px);
  opacity: 0.9;
}

/* Forms */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #555;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid rgba(102, 126, 234, 0.2);
  border-radius: 8px;
  font-size: 1rem;
  background: rgba(255, 255, 255, 0.8);
}

.form-control:focus {
  border-color: #667eea;
  outline: none;
  background: white;
}

/* Calendar */
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #ddd;
  border-radius: 10px;
  overflow: hidden;
}

.calendar-header {
  background: #667eea;
  color: white;
  padding: 10px;
  text-align: center;
  font-weight: bold;
}

.calendar-day {
  background: white;
  padding: 10px;
  min-height: 60px;
  border: 1px solid #eee;
  position: relative;
  cursor: pointer;
}

.calendar-day:hover {
  background: #f8f9fa;
}

.calendar-day.has-orders {
  background: rgba(102, 126, 234, 0.1);
}

.calendar-day.blocked {
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
}

.order-dot {
  width: 8px;
  height: 8px;
  background: #667eea;
  border-radius: 50%;
  position: absolute;
  top: 5px;
  right: 5px;
}

/* Notifications */
.notification-panel {
  position: fixed;
  top: 20px;
  right: 20px;
  max-width: 350px;
  z-index: 1000;
}

.notification {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-left: 4px solid #667eea;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  animation: slideIn 0.3s ease;
}

.notification.success { border-left-color: #28a745; }
.notification.warning { border-left-color: #ffc107; }
.notification.error { border-left-color: #dc3545; }

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 20px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.close-modal {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #999;
}

.close-modal:hover {
  color: #333;
}

/* Debug & Fallback Styles */
.status-indicator {
  display: flex;
  align-items: center;
  margin: 8px 0;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
}

.status-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 10px;
  display: inline-block;
}

.status-checking {
  background: #ffc107;
  animation: pulse 1.5s infinite;
}

.status-online {
  background: #28a745;
}

.status-offline {
  background: #dc3545;
}

.status-warning {
  background: #fd7e14;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.status-badge {
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: bold;
  text-transform: uppercase;
}

.status-active {
  background: #d4edda;
  color: #155724;
}

.status-inactive {
  background: #f8d7da;
  color: #721c24;
}

.fallback-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}

.fallback-item:last-child {
  border-bottom: none;
}

.pending-email-item {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 12px;
  margin: 8px 0;
}

.pending-email-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 8px;
}

.pending-email-type {
  background: #007bff;
  color: white;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.7rem;
  text-transform: uppercase;
}

.pending-email-time {
  font-size: 0.8rem;
  color: #666;
}

.pending-email-preview {
  font-size: 0.9rem;
  color: #333;
  margin-top: 5px;
}

.emergency-controls {
  border: 2px solid #dc3545;
  border-radius: 8px;
  padding: 15px;
  background: #fff5f5;
}

.notification-item {
  display: flex;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
  background: white;
  border-radius: 4px;
  margin: 5px 0;
}

.notification-item.unread {
  background: #e3f2fd;
  border-left: 3px solid #2196f3;
}

.notification-icon {
  width: 20px;
  height: 20px;
  margin-right: 10px;
  font-size: 16px;
}

.notification-content {
  flex: 1;
}

.notification-time {
  font-size: 0.8rem;
  color: #666;
}

/* PWA Enhancements */
.pwa-install-banner {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px;
  text-align: center;
  transform: translateY(100%);
  transition: transform 0.3s ease;
  z-index: 10000;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
}

.pwa-install-banner.show {
  transform: translateY(0);
}

.pwa-install-banner button {
  background: white;
  color: #667eea;
  border: none;
  padding: 10px 20px;
  border-radius: 25px;
  font-weight: bold;
  margin: 0 5px;
  cursor: pointer;
  touch-action: manipulation;
}

.pwa-install-banner button:hover {
  background: #f8f9fa;
}

/* Touch-friendly enhancements */
button, .action-btn, .nav-tab {
  min-height: 44px;
  min-width: 44px;
  touch-action: manipulation;
  -webkit-user-select: none;
  user-select: none;
}

/* App-like loading screen */
.app-loading {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10001;
  color: white;
  transition: opacity 0.5s ease;
}

.app-loading.hidden {
  opacity: 0;
  pointer-events: none;
}

.app-logo {
  font-size: 4rem;
  margin-bottom: 20px;
  animation: pulse 2s infinite;
}

.app-name {
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 10px;
}

.app-tagline {
  font-size: 1rem;
  opacity: 0.8;
  margin-bottom: 30px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top: 3px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Connection status indicator */
.connection-status {
  position: fixed;
  top: env(safe-area-inset-top, 10px);
  right: env(safe-area-inset-right, 10px);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 0.8rem;
  z-index: 9999;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.connection-status.online {
  background: rgba(40, 167, 69, 0.9);
}

.connection-status.offline {
  background: rgba(220, 53, 69, 0.9);
}

/* Pull-to-refresh indicator */
.pull-to-refresh {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%) translateY(-100%);
  background: rgba(255,255,255,0.9);
  padding: 10px 20px;
  border-radius: 0 0 15px 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.3s ease;
  z-index: 9998;
}

.pull-to-refresh.show {
  transform: translateX(-50%) translateY(0);
}

/* App update banner */
.app-update-banner {
  position: fixed;
  top: env(safe-area-inset-top, 0);
  left: 0;
  right: 0;
  background: #ffc107;
  color: #333;
  padding: 10px;
  text-align: center;
  font-size: 0.9rem;
  z-index: 9997;
  transform: translateY(-100%);
  transition: transform 0.3s ease;
}

.app-update-banner.show {
  transform: translateY(0);
}

.app-update-banner button {
  background: #333;
  color: white;
  border: none;
  padding: 5px 15px;
  border-radius: 15px;
  margin-left: 10px;
  cursor: pointer;
}

/* Responsive */
@media (max-width: 768px) {
  .dashboard {
    padding: 10px;
  }
  
  .dashboard-header {
    flex-direction: column;
    gap: 10px;
    text-align: center;
    padding: 15px 10px;
  }
  
  .dashboard-header h1 {
    font-size: 1.5rem;
    margin: 0;
  }
  
  .header-controls {
    flex-direction: column;
    gap: 10px;
    align-items: center;
  }
  
  .user-info {
    margin: 0;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 15px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .nav-tabs {
    padding: 5px;
    gap: 2px;
    flex-wrap: wrap;
    justify-content: space-around;
    background: rgba(255, 255, 255, 0.95);
    margin: 0 -5px;
    overflow-x: auto;
    overflow-y: visible;
    max-height: none;
    /* Enhanced scrolling for mobile */
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
  }
  
  .nav-tabs::-webkit-scrollbar {
    height: 3px;
  }
  
  .nav-tabs::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .nav-tabs::-webkit-scrollbar-thumb {
    background: rgba(102, 126, 234, 0.3);
    border-radius: 2px;
  }
  
  .nav-tab {
    padding: 6px 8px;
    font-size: 0.75rem;
    min-width: 70px;
    flex: 0 0 auto;
    text-align: center;
    margin: 1px;
    white-space: nowrap;
    line-height: 1.1;
    border-radius: 12px;
    /* Prevent text wrapping */
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .nav-tab.active {
    font-weight: 600;
    transform: none; /* Remove transform on mobile to prevent overlap */
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
    gap: 15px;
    margin-top: 10px;
  }
  
  .dashboard-card {
    padding: 15px;
    margin-bottom: 10px;
  }
  
  .data-table {
    font-size: 0.8rem;
    overflow-x: auto;
  }
  
  .data-table th,
  .data-table td {
    padding: 6px 4px;
    word-wrap: break-word;
    min-width: 80px;
  }
  
  .login-box {
    padding: 30px 20px;
    margin: 20px;
  }
  
  .activity-item {
    padding: 10px;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }
  
  /* Fix action buttons on mobile */
  .action-btn {
    padding: 8px 12px;
    font-size: 0.85rem;
    margin: 3px 2px;
  }
  
  /* Ensure proper spacing */
  .tab-content {
    margin-top: 15px;
    min-height: calc(100vh - 200px);
  }
}

/* Extra small mobile devices */
@media (max-width: 480px) {
  .dashboard-header h1 {
    font-size: 1.3rem;
  }
  
  .nav-tab {
    font-size: 0.7rem;
    padding: 5px 6px;
    min-width: 60px;
  }
  
  .user-info {
    font-size: 10px;
    padding: 4px 8px;
    max-width: 150px;
  }
  
  .dashboard-card h2 {
    font-size: 1.1rem;
  }
  
  .action-btn {
    padding: 6px 10px;
    font-size: 0.8rem;
  }
}

/* Print Styles */
@media print {
  .nav-tabs, .header-controls, .action-btn {
    display: none !important;
  }
  
  .dashboard-card {
    break-inside: avoid;
  }
}
</style>
</head>
<body>

<!-- App Loading Screen -->
<div class="app-loading" id="appLoading">
  <div class="app-logo"><img src="pictures/logo.png" alt="Cupcakes on the Avenue" style="width: 80px; height: 80px; border-radius: 50%;"></div>
  <div class="app-name">Cupcakes on the Avenue</div>
  <div class="app-tagline">Admin Dashboard</div>
  <div class="loading-spinner"></div>
</div>

<!-- Connection Status -->
<div class="connection-status online" id="connectionStatus">
  🟢 Online
</div>

<!-- App Update Banner -->
<div class="app-update-banner" id="appUpdateBanner">
  📱 A new version is available! 
  <button onclick="updateApp()">Update</button>
  <button onclick="dismissUpdate()">Later</button>
</div>

<!-- Pull to Refresh -->
<div class="pull-to-refresh" id="pullToRefresh">
  🔄 Release to refresh
</div>

<!-- PWA Install Banner -->
<div class="pwa-install-banner" id="installBanner">
  📱 Install Cupcakes on the Avenue Admin for the best experience!
  <br>
  <button onclick="installApp()">Install App</button>
  <button onclick="dismissInstall()">Not Now</button>
</div>

<!-- Login Screen -->
<div class="login-container" id="loginContainer">
  <div class="login-box">
    <div id="loginView">
      <h1>🔐 Admin Login</h1>
      <p style="color: #666; margin-bottom: 30px;">Access the comprehensive admin dashboard</p>
      <form id="loginForm">
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit" class="login-btn">Login</button>
        <div class="error-message" id="errorMessage"></div>
      </form>
      <p style="text-align: center; margin-top: 20px; color: #666;">
        Don't have an account? 
        <a href="#" onclick="showSignup()" style="color: #667eea; text-decoration: none;">Sign up here</a>
      </p>
    </div>

    <div id="signupView" style="display: none;">
      <h1>👤 Create Admin Account</h1>
      <p style="color: #666; margin-bottom: 30px;">Join the admin team</p>
      <form id="signupForm">
        <input type="text" id="signupFullName" placeholder="Full Name" required>
        <input type="text" id="signupUsername" placeholder="Username" required>
        <input type="email" id="signupEmail" placeholder="Email" required>
        <input type="password" id="signupPassword" placeholder="Password" required>
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
        <select id="userRole" required style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; width: 100%; font-size: 16px;">
          <option value="">Select Role</option>
          <option value="admin">Admin (Full Access)</option>
          <option value="manager">Manager (Orders & Inventory)</option>
          <option value="staff">Staff (Orders Only)</option>
        </select>
        <button type="submit" class="login-btn">Create Account</button>
        <div class="error-message" id="signupErrorMessage"></div>
      </form>
      <p style="text-align: center; margin-top: 20px; color: #666;">
        Already have an account? 
        <a href="#" onclick="showLogin()" style="color: #667eea; text-decoration: none;">Login here</a>
      </p>
    </div>
  </div>
</div>

<!-- Notification Panel -->
<div class="notification-panel" id="notificationPanel"></div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
  <div class="dashboard-header">
    <h1>🧁 Cupcakes on the Avenue Admin</h1>
    <div class="header-controls">
      <div class="user-info" style="margin-right: 15px; padding: 8px 15px; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 14px;">
        👤 <span id="currentUserName">Admin User</span> 
        <span style="opacity: 0.7;">(<span id="currentUserRole">admin</span>)</span>
      </div>
      <span id="lastUpdate">Last updated: Never</span>
      <button class="refresh-btn" id="refreshAll">🔄 Refresh</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="overview">📊 Overview</button>
    <button class="nav-tab" data-tab="orders">📋 Orders</button>
    <button class="nav-tab" data-tab="customers">👥 Customers</button>
    <button class="nav-tab" data-tab="calendar">📅 Calendar</button>
    <button class="nav-tab" data-tab="analytics">📈 Analytics</button>
    <button class="nav-tab" data-tab="inventory">📦 Inventory</button>
    <button class="nav-tab" data-tab="finances">💰 Finances</button>
    <button class="nav-tab" data-tab="communications">📱 Communications</button>
    <button class="nav-tab" data-tab="activity">👁️ Activity Log</button>
    <button class="nav-tab" data-tab="debug">🔧 Debug & Fallbacks</button>
    <button class="nav-tab" data-tab="settings">⚙️ Settings</button>
  </div>

  <!-- Overview Tab -->
  <div class="tab-content active" id="overview">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>📊 Today's Summary</h2>
        <div class="stat-item">
          <span>New Orders</span>
          <span class="stat-value" id="todayOrders">0</span>
        </div>
        <div class="stat-item">
          <span>Revenue</span>
          <span class="stat-value" id="todayRevenue">£0.00</span>
        </div>
        <div class="stat-item">
          <span>Pending Orders</span>
          <span class="stat-value" id="pendingOrders">0</span>
        </div>
        <div class="stat-item">
          <span>Customer Messages</span>
          <span class="stat-value" id="newMessages">0</span>
        </div>
      </div>

      <div class="dashboard-card">
        <h2>📈 This Week</h2>
        <div class="stat-item">
          <span>Total Orders</span>
          <span class="stat-value" id="weekOrders">0</span>
        </div>
        <div class="stat-item">
          <span>Revenue</span>
          <span class="stat-value" id="weekRevenue">£0.00</span>
        </div>
        <div class="stat-item">
          <span>New Customers</span>
          <span class="stat-value" id="newCustomers">0</span>
        </div>
        <div class="stat-item">
          <span>Avg Order Value</span>
          <span class="stat-value" id="avgOrderValue">£0.00</span>
        </div>
      </div>

      <div class="dashboard-card">
        <h2>🎯 Key Metrics</h2>
        <div class="stat-item">
          <span>Total Customers</span>
          <span class="stat-value" id="totalCustomers">0</span>
        </div>
        <div class="stat-item">
          <span>Repeat Customers</span>
          <span class="stat-value" id="repeatCustomers">0</span>
        </div>
        <div class="stat-item">
          <span>Monthly Revenue</span>
          <span class="stat-value" id="monthlyRevenue">£0.00</span>
        </div>
        <div class="stat-item">
          <span>Outstanding Payments</span>
          <span class="stat-value" id="outstandingPayments">£0.00</span>
        </div>
      </div>

      <div class="dashboard-card">
        <h2>🧁 Top Products</h2>
        <div id="topProducts">
          <div class="stat-item">
            <span>Shortbread Delight</span>
            <span class="stat-value">24 sold</span>
          </div>
          <div class="stat-item">
            <span>Vanilla Cupcakes</span>
            <span class="stat-value">18 sold</span>
          </div>
          <div class="stat-item">
            <span>Chocolate Brownies</span>
            <span class="stat-value">15 sold</span>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <h2>📈 Revenue Chart (Last 7 Days)</h2>
      <div class="chart-container">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Orders Tab -->
  <div class="tab-content" id="orders">
    <div class="table-container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>📋 Order Management</h2>
        <div>
          <button class="action-btn btn-primary" onclick="exportOrders()">📄 Export</button>
          <button class="action-btn btn-success" onclick="addOrder()">➕ Add Order</button>
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <input type="text" class="form-control" placeholder="🔍 Search orders..." id="orderSearch" style="max-width: 300px; display: inline-block; margin-right: 10px;">
        <select class="form-control" id="orderFilter" style="max-width: 200px; display: inline-block;">
          <option value="">All Status</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>

      <table class="data-table" id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Delivery Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersTableBody">
          <!-- Orders will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Customers Tab -->
  <div class="tab-content" id="customers">
    <div class="table-container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>👥 Customer Management</h2>
        <div>
          <button class="action-btn btn-primary" onclick="exportCustomers()">📄 Export</button>
          <button class="action-btn btn-success" onclick="addCustomer()">➕ Add Customer</button>
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <input type="text" class="form-control" placeholder="🔍 Search customers..." id="customerSearch" style="max-width: 300px; display: inline-block;">
      </div>

      <table class="data-table" id="customersTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Total Orders</th>
            <th>Total Spent</th>
            <th>Last Order</th>
            <th>Loyalty Points</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customersTableBody">
          <!-- Customers will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Calendar Tab -->
  <div class="tab-content" id="calendar">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>📅 Order Calendar</h2>
        <div style="margin-bottom: 20px;">
          <button class="action-btn btn-primary" onclick="prevMonth()">← Previous</button>
          <span id="currentMonth" style="margin: 0 20px; font-weight: bold;"></span>
          <button class="action-btn btn-primary" onclick="nextMonth()">Next →</button>
        </div>
        <div class="calendar" id="orderCalendar">
          <!-- Calendar will be generated here -->
        </div>
      </div>
      
      <div class="dashboard-card">
        <h2>🚫 Blocked Dates</h2>
        <div style="margin-bottom: 20px;">
          <input type="date" class="form-control" id="blockDate" style="margin-bottom: 10px;">
          <button class="action-btn btn-danger" onclick="blockDate()">Block Date</button>
        </div>
        <div id="blockedDatesList">
          <!-- Blocked dates will be listed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Tab -->
  <div class="tab-content" id="analytics">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>📊 Sales Analytics</h2>
        <div class="chart-container">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
      
      <div class="dashboard-card">
        <h2>🧁 Product Performance</h2>
        <div class="chart-container">
          <canvas id="productChart"></canvas>
        </div>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>👥 Customer Analytics</h2>
        <div class="chart-container">
          <canvas id="customerChart"></canvas>
        </div>
      </div>
      
      <div class="dashboard-card">
        <h2>📈 Growth Metrics</h2>
        <div class="stat-item">
          <span>Month-over-Month Growth</span>
          <span class="stat-value">+12.5%</span>
        </div>
        <div class="stat-item">
          <span>Customer Retention Rate</span>
          <span class="stat-value">68%</span>
        </div>
        <div class="stat-item">
          <span>Average Order Frequency</span>
          <span class="stat-value">2.3/month</span>
        </div>
        <div class="stat-item">
          <span>Peak Order Day</span>
          <span class="stat-value">Saturday</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory Tab -->
  <div class="tab-content" id="inventory">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>📦 Stock Levels</h2>
        <div style="margin-bottom: 20px;">
          <button class="action-btn btn-success" onclick="addInventoryItem()">➕ Add Item</button>
          <button class="action-btn btn-warning" onclick="generateShoppingList()">📝 Shopping List</button>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Current Stock</th>
              <th>Low Stock Alert</th>
              <th>Unit Cost</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="inventoryTableBody">
            <!-- Inventory items will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Finances Tab -->
  <div class="tab-content" id="finances">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>💰 Financial Overview</h2>
        <div class="stat-item">
          <span>Today's Revenue</span>
          <span class="stat-value">£156.50</span>
        </div>
        <div class="stat-item">
          <span>This Week</span>
          <span class="stat-value">£892.30</span>
        </div>
        <div class="stat-item">
          <span>This Month</span>
          <span class="stat-value">£3,245.80</span>
        </div>
        <div class="stat-item">
          <span>Outstanding Payments</span>
          <span class="stat-value">£425.00</span>
        </div>
      </div>
      
      <div class="dashboard-card">
        <h2>📊 Payment Tracking</h2>
        <div class="chart-container">
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
    </div>
    
    <div class="table-container">
      <h2>💳 Payment Management</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Total Amount</th>
            <th>Deposit (25%)</th>
            <th>Remaining</th>
            <th>Deposit Status</th>
            <th>Final Payment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="paymentsTableBody">
          <!-- Payment tracking will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Communications Tab -->
  <div class="tab-content" id="communications">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>📱 Push Notifications</h2>
        <div class="form-group">
          <label>Notification Type</label>
          <select class="form-control" id="notificationType">
            <option value="weekly-bakes">Weekly Bakes Update</option>
            <option value="new-product">New Product Launch</option>
            <option value="discount">Special Offer</option>
            <option value="market-special">Market Special</option>
            <option value="custom">Custom Message</option>
          </select>
        </div>
        <div class="form-group">
          <label>Message</label>
          <textarea class="form-control" id="notificationMessage" rows="3" placeholder="Enter your notification message..."></textarea>
        </div>
        <button class="action-btn btn-primary" onclick="sendPushNotification()">📤 Send to All</button>
      </div>
      
      <div class="dashboard-card">
        <h2>👤 Individual Customer Contact</h2>
        <div class="form-group">
          <label>Select Customer</label>
          <select class="form-control" id="individualCustomer">
            <option value="">Choose a customer...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Contact Method</label>
          <select class="form-control" id="contactMethod">
            <option value="push">Push Notification</option>
            <option value="email">Email</option>
            <option value="sms">SMS</option>
            <option value="call">Phone Call</option>
          </select>
        </div>
        <div class="form-group">
          <label>Message</label>
          <textarea class="form-control" id="individualMessage" rows="3" placeholder="Personal message to customer..."></textarea>
        </div>
        <div class="form-group">
          <button class="action-btn btn-success" onclick="contactIndividualCustomer()">📞 Send Message</button>
          <button class="action-btn btn-info" onclick="viewCustomerHistory()">📋 View History</button>
        </div>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>📧 Email Campaign</h2>
        <div class="form-group">
          <label>Recipients</label>
          <select class="form-control" id="emailRecipients">
            <option value="all">All Customers</option>
            <option value="recent">Recent Customers (30 days)</option>
            <option value="loyal">Loyal Customers</option>
            <option value="inactive">Inactive Customers</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject</label>
          <input type="text" class="form-control" id="emailSubject" placeholder="Email subject...">
        </div>
        <div class="form-group">
          <label>Message</label>
          <textarea class="form-control" id="emailMessage" rows="4" placeholder="Email content..."></textarea>
        </div>
        <button class="action-btn btn-primary" onclick="sendEmailCampaign()">📧 Send Email</button>
      </div>
      
      <div class="dashboard-card">
        <h2>📊 Communication History</h2>
        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Method</th>
                <th>Message</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="communicationHistory">
              <!-- Communication history will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="dashboard-card">
      <h2>📱 Social Media Scheduler</h2>
      <div class="form-group">
        <label>Platform</label>
        <select class="form-control" id="socialPlatform">
          <option value="instagram">Instagram</option>
          <option value="facebook">Facebook</option>
          <option value="twitter">Twitter</option>
        </select>
      </div>
      <div class="form-group">
        <label>Post Content</label>
        <textarea class="form-control" id="socialContent" rows="3" placeholder="What's happening at the bakery..."></textarea>
      </div>
      <div class="form-group">
        <label>Schedule for</label>
        <input type="datetime-local" class="form-control" id="socialSchedule">
      </div>
      <button class="action-btn btn-primary" onclick="scheduleSocialPost()">📅 Schedule Post</button>
    </div>
  </div>

  <!-- Activity Log Tab -->
  <div class="tab-content" id="activity">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>👁️ Activity Log</h2>
        <div style="margin-bottom: 20px;">
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <select id="activityFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="all">All Activities</option>
              <option value="login">Login/Logout</option>
              <option value="orders">Order Changes</option>
              <option value="customers">Customer Changes</option>
              <option value="inventory">Inventory Changes</option>
              <option value="settings">Settings Changes</option>
            </select>
            <select id="userFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="all">All Users</option>
            </select>
            <input type="date" id="dateFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="filterActivityLog()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 4px;">Filter</button>
            <button onclick="exportActivityLog()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px;">📄 Export</button>
          </div>
        </div>
        <div id="activityLogContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;">
          <div class="activity-log" id="activityLogList">
            <!-- Activity log entries will be populated here -->
          </div>
        </div>
      </div>

      <div class="dashboard-card">
        <h2>📊 Activity Summary</h2>
        <div class="activity-stats">
          <div class="stat-item">
            <span class="stat-label">Total Actions Today:</span>
            <span class="stat-value" id="todayActions">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Active Users:</span>
            <span class="stat-value" id="activeUsers">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Last Activity:</span>
            <span class="stat-value" id="lastActivity">Never</span>
          </div>
        </div>
        
        <h3 style="margin-top: 20px;">📈 User Activity Chart</h3>
        <div id="activityChart" style="height: 200px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">
          Activity chart will appear here
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div class="tab-content" id="settings">
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h2>⚙️ General Settings</h2>
        <div class="form-group">
          <label>Business Name</label>
          <input type="text" class="form-control" value="Cupcakes on the Avenue" id="businessName">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" class="form-control" value="07842817789" id="businessPhone">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" value="cupcakesontheavenue@gmail.com" id="businessEmail">
        </div>
        <div class="form-group">
          <label>Minimum Lead Time (days)</label>
          <input type="number" class="form-control" value="7" id="leadTime">
        </div>
        <button class="action-btn btn-success" onclick="saveSettings()">💾 Save Settings</button>
      </div>
      
      <div class="dashboard-card">
        <h2>🔔 Notification Settings</h2>
        <div class="form-group">
          <label>
            <input type="checkbox" id="emailNotifications" checked> Email Notifications
          </label>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="smsNotifications" checked> SMS Notifications
          </label>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="discordNotifications" checked> Discord Notifications
          </label>
        </div>
        <div class="form-group">
          <label>Discord Webhook URL</label>
          <input type="url" class="form-control" id="discordWebhook" value="https://discord.com/api/webhooks/1426192909044023297/Ilgqgr8p7buI95ai-zssfphPLzQlNBBZf6PY31BhVuptPd-ZyccSq5kAQJPoBkUt4PHK">
        </div>
        <button class="action-btn btn-primary" onclick="testDiscordWebhook()">🧪 Test Discord</button>
      </div>
    </div>
    
    <div class="dashboard-card">
      <h2>🛡️ Security</h2>
      <div class="form-group">
        <label>Change Password</label>
        <input type="password" class="form-control" placeholder="New password" id="newPassword">
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" class="form-control" placeholder="Confirm new password" id="confirmPassword">
      </div>
      <button class="action-btn btn-warning" onclick="changePassword()">🔐 Change Password</button>
      
      <hr style="margin: 20px 0;">
      
      <div class="form-group">
        <label>Data Backup</label>
        <button class="action-btn btn-info" onclick="backupData()">💾 Download Backup</button>
        <button class="action-btn btn-warning" onclick="restoreData()">📥 Restore Data</button>
      </div>
      
      <hr style="margin: 20px 0;">
      
      <div class="form-group">
        <label>Data Management</label>
        <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">Reset all data including orders, inventory, customers, and activities. This action cannot be undone.</p>
        <button class="action-btn btn-danger" onclick="confirmResetAllData()" style="background-color: #dc3545;">🗑️ Reset All Data</button>
      </div>
    </div>
  </div>

  <!-- Debug & Fallbacks Tab -->
  <div class="tab-content" id="debug">
    <div class="dashboard-grid">
      <!-- System Status Card -->
      <div class="dashboard-card">
        <h2>🔍 System Diagnostics</h2>
        <div id="systemStatus">
          <div class="status-indicator" id="backendStatus">
            <span class="status-dot status-checking"></span>
            <span>Backend Connection: Checking...</span>
          </div>
          <div class="status-indicator" id="emailStatus">
            <span class="status-dot status-checking"></span>
            <span>Email System: Checking...</span>
          </div>
          <div class="status-indicator" id="storageStatus">
            <span class="status-dot status-checking"></span>
            <span>Local Storage: Checking...</span>
          </div>
          <div class="status-indicator" id="mobileStatus">
            <span class="status-dot status-checking"></span>
            <span>Mobile Compatibility: Checking...</span>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <button class="action-btn btn-primary" onclick="runFullSystemDiagnostic()">🔄 Run Full Diagnostic</button>
          <button class="action-btn btn-info" onclick="testBackendEndpoints()">🔌 Test Backend</button>
        </div>
      </div>

      <!-- Pending Email Notifications -->
      <div class="dashboard-card">
        <h2>📧 Pending Email Notifications</h2>
        <div id="pendingEmailsCount" class="metric-value">Loading...</div>
        <div id="pendingEmailsList" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
          <!-- Pending emails will be populated here -->
        </div>
        <div style="margin-top: 15px;">
          <button class="action-btn btn-success" onclick="processPendingEmails()">✉️ Process All Emails</button>
          <button class="action-btn btn-warning" onclick="clearProcessedEmails()">🗑️ Clear Processed</button>
          <button class="action-btn btn-info" onclick="exportEmailQueue()">💾 Export Queue</button>
        </div>
      </div>

      <!-- Mobile Testing Tools -->
      <div class="dashboard-card">
        <h2>📱 Mobile Testing</h2>
        <div id="deviceInfo">
          <p><strong>Current Device:</strong> <span id="deviceType">Unknown</span></p>
          <p><strong>Screen Size:</strong> <span id="screenSize">Unknown</span></p>
          <p><strong>Touch Support:</strong> <span id="touchSupport">Unknown</span></p>
          <p><strong>Orientation:</strong> <span id="orientation">Unknown</span></p>
        </div>
        <div style="margin-top: 20px;">
          <button class="action-btn btn-primary" onclick="testMobileLayout()">📱 Test Mobile Layout</button>
          <button class="action-btn btn-info" onclick="testTouchInterface()">👆 Test Touch Interface</button>
          <button class="action-btn btn-warning" onclick="simulateMobileView()">📲 Simulate Mobile View</button>
        </div>
      </div>

      <!-- Fallback Systems -->
      <div class="dashboard-card">
        <h2>🛡️ Fallback Systems</h2>
        <div id="fallbackStatus">
          <div class="fallback-item">
            <span>📧 Email Fallback:</span>
            <span class="status-badge status-active" id="emailFallbackStatus">Active</span>
          </div>
          <div class="fallback-item">
            <span>💾 Local Storage Backup:</span>
            <span class="status-badge status-active" id="storageFallbackStatus">Active</span>
          </div>
          <div class="fallback-item">
            <span>🔔 Visual Notifications:</span>
            <span class="status-badge status-active" id="notificationFallbackStatus">Active</span>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <button class="action-btn btn-success" onclick="testFallbackSystems()">🧪 Test Fallback Systems</button>
          <button class="action-btn btn-info" onclick="toggleFallbackMode()">🔄 Toggle Fallback Mode</button>
        </div>
      </div>

      <!-- Admin Notifications -->
      <div class="dashboard-card">
        <h2>🔔 Admin Notifications</h2>
        <div id="adminNotificationsList" style="max-height: 250px; overflow-y: auto;">
          <!-- Admin notifications will be populated here -->
        </div>
        <div style="margin-top: 15px;">
          <button class="action-btn btn-primary" onclick="markAllNotificationsRead()">✅ Mark All Read</button>
          <button class="action-btn btn-warning" onclick="clearOldNotifications()">🗑️ Clear Old</button>
        </div>
      </div>

      <!-- Emergency Manual Override -->
      <div class="dashboard-card">
        <h2>🚨 Emergency Manual Override</h2>
        <div class="emergency-controls">
          <div class="form-group">
            <label>Manual Email Processing</label>
            <textarea class="form-control" id="manualEmailContent" placeholder="Enter email content to send manually..." rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>Recipient Email</label>
            <input type="email" class="form-control" id="manualEmailRecipient" placeholder="Enter recipient email">
          </div>
          <div class="form-group">
            <label>Subject</label>
            <input type="text" class="form-control" id="manualEmailSubject" placeholder="Enter email subject">
          </div>
          <button class="action-btn btn-danger" onclick="sendManualEmail()">📤 Send Manual Email</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Modal Title</h3>
      <button class="close-modal" onclick="closeModal()">&times;</button>
    </div>
    <div id="modalBody">
      <!-- Modal content will be populated here -->
    </div>
  </div>
</div>

<script>
// Global variables
let currentUser = null;
let adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '[]');
let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
let orders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
let customers = JSON.parse(localStorage.getItem('adminCustomers') || '[]');
let inventory = JSON.parse(localStorage.getItem('adminInventory') || '[]');
let blockedDates = JSON.parse(localStorage.getItem('adminBlockedDates') || '[]');
let currentDate = new Date();
let charts = {};

// Cross-device sync configuration
const SYNC_SERVER_URL = 'https://www.cupcakesontheavenue.com/api/sync'; // Replace with your actual server endpoint
const SYNC_ENABLED = false; // Set to true when you have a backend
let lastSyncTime = localStorage.getItem('lastSyncTime') || null;
let syncInProgress = false;

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
  setupEventListeners();
  loadExistingData(); // Load existing data instead of resetting
  loadActivityLog();
  setupAutoSync(); // Setup automatic synchronization
});

function loadExistingData() {
  // Only reset data if explicitly requested or if it's a fresh install
  const hasExistingData = localStorage.getItem('adminOrders') || 
                         localStorage.getItem('adminCustomers') || 
                         localStorage.getItem('adminInventory');
  
  if (!hasExistingData) {
    // First time setup - start with empty data
    resetAllAdminData();
    logActivity('System', 'System initialized with empty data');
  } else {
    // Load existing data and sync across devices
    syncDataFromStorage();
    logActivity('System', 'Existing data loaded successfully');
  }
}

function initializeApp() {
  // Check if user is already logged in and session is valid
  const savedUser = localStorage.getItem('adminUser');
  const sessionExpiry = localStorage.getItem('adminSessionExpiry');
  
  if (savedUser && sessionExpiry && new Date().getTime() < parseInt(sessionExpiry)) {
    currentUser = JSON.parse(savedUser);
    logActivity('system', 'Auto-login from saved session');
    showDashboard();
    updateUserDisplay();
    
    // Start auto-sync when user is authenticated
    if (SYNC_ENABLED) {
      startAutoSync();
      // Initial sync on app start
      setTimeout(() => syncDataWithCloud(), 2000);
    }
  } else {
    // Clear expired session
    localStorage.removeItem('adminUser');
    localStorage.removeItem('adminSessionExpiry');
    showLogin();
  }
}

// User Authentication System
function showLogin() {
  document.getElementById('loginView').style.display = 'block';
  document.getElementById('signupView').style.display = 'none';
}

function showSignup() {
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('signupView').style.display = 'block';
}

function updateUserDisplay() {
  if (currentUser) {
    document.getElementById('currentUserName').textContent = currentUser.fullName || currentUser.username;
    document.getElementById('currentUserRole').textContent = currentUser.role || 'admin';
  }
}

// Activity Logging System
function logActivity(type, action, details = '') {
  const activity = {
    id: Date.now(),
    timestamp: new Date().toISOString(),
    user: currentUser ? currentUser.username : 'System',
    userFullName: currentUser ? currentUser.fullName : 'System',
    type: type,
    action: action,
    details: details,
    deviceInfo: getDeviceInfo(),
    ip: 'localhost' // In real implementation, get actual IP
  };
  
  activityLog.unshift(activity); // Add to beginning
  
  // Keep only last 1000 activities to prevent storage bloat
  if (activityLog.length > 1000) {
    activityLog = activityLog.slice(0, 1000);
  }
  
  localStorage.setItem('activityLog', JSON.stringify(activityLog));
  updateActivityDisplay();
  
  // Instantly sync activity log across all devices
  saveAllDataInstantly();
}

function getDeviceInfo() {
  const ua = navigator.userAgent;
  let device = 'Desktop';
  
  if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua)) {
    if (/iPad/i.test(ua)) device = 'Tablet (iPad)';
    else if (/iPhone/i.test(ua)) device = 'Mobile (iPhone)';
    else if (/Android/i.test(ua)) {
      device = ua.includes('Mobile') ? 'Mobile (Android)' : 'Tablet (Android)';
    } else device = 'Mobile';
  }
  
  return device;
}

function setupEventListeners() {
  // Login form
  document.getElementById('loginForm').addEventListener('submit', handleLogin);
  
  // Signup form
  document.getElementById('signupForm').addEventListener('submit', handleSignup);
  
  // Logout button
  document.getElementById('logoutBtn').addEventListener('click', logout);
  
  // Refresh button
  document.getElementById('refreshAll').addEventListener('click', refreshAllData);
  
  // Tab navigation
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });
  
  // Search and filter
  document.getElementById('orderSearch')?.addEventListener('input', filterOrders);
  document.getElementById('orderFilter')?.addEventListener('change', filterOrders);
  document.getElementById('customerSearch')?.addEventListener('input', filterCustomers);
}

// Enhanced Authentication Functions
function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  
  if (!username || !password) {
    showError('loginErrorMessage', 'Please enter both username and password');
    return;
  }
  
  // Check if user exists
  const user = adminUsers.find(u => u.username === username);
  
  if (!user) {
    // Create default admin if no users exist
    if (adminUsers.length === 0 && username === 'admin' && password === 'cupcakes2025') {
      const defaultAdmin = {
        id: Date.now(),
        username: 'admin',
        fullName: 'Admin User',
        email: 'admin@cupcakesontheavenue.com',
        password: 'cupcakes2025', // In production, hash this
        role: 'admin',
        createdAt: new Date().toISOString(),
        lastLogin: null
      };
      adminUsers.push(defaultAdmin);
      localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
      authenticateUser(defaultAdmin, password);
    } else {
      showError('loginErrorMessage', 'User not found');
    }
    return;
  }
  
  // Verify password (in production, use proper hashing)
  if (user.password !== password) {
    logActivity('security', 'Failed login attempt', `Username: ${username}`);
    showError('loginErrorMessage', 'Invalid password');
    return;
  }
  
  authenticateUser(user, password);
}

function handleSignup(e) {
  e.preventDefault();
  const formData = {
    fullName: document.getElementById('signupFullName').value.trim(),
    username: document.getElementById('signupUsername').value.trim(),
    email: document.getElementById('signupEmail').value.trim(),
    password: document.getElementById('signupPassword').value,
    confirmPassword: document.getElementById('confirmPassword').value,
    role: document.getElementById('userRole').value
  };
  
  // Validation
  if (!formData.fullName || !formData.username || !formData.email || !formData.password || !formData.role) {
    showError('signupErrorMessage', 'Please fill in all fields');
    return;
  }
  
  if (formData.password !== formData.confirmPassword) {
    showError('signupErrorMessage', 'Passwords do not match');
    return;
  }
  
  if (formData.password.length < 6) {
    showError('signupErrorMessage', 'Password must be at least 6 characters');
    return;
  }
  
  // Check if username or email already exists
  if (adminUsers.find(u => u.username === formData.username)) {
    showError('signupErrorMessage', 'Username already exists');
    return;
  }
  
  if (adminUsers.find(u => u.email === formData.email)) {
    showError('signupErrorMessage', 'Email already exists');
    return;
  }
  
  // Create new user
  const newUser = {
    id: Date.now(),
    username: formData.username,
    fullName: formData.fullName,
    email: formData.email,
    password: formData.password, // In production, hash this
    role: formData.role,
    createdAt: new Date().toISOString(),
    lastLogin: null
  };
  
  adminUsers.push(newUser);
  
  // Instantly save and sync all data across devices
  saveAllDataInstantly();
  
  logActivity('user', 'New user account created', `User: ${newUser.username} (${newUser.role})`);
  
  // Auto-login after signup
  authenticateUser(user);
}

function authenticateUser(user, password = null) {
  currentUser = user;
  currentUser.lastLogin = new Date().toISOString();
  
  // Update user in storage
  const userIndex = adminUsers.findIndex(u => u.id === user.id);
  if (userIndex !== -1) {
    adminUsers[userIndex] = currentUser;
    localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
  }
  
  // Set session with 24 hour expiry
  const sessionExpiry = new Date().getTime() + (24 * 60 * 60 * 1000);
  localStorage.setItem('adminUser', JSON.stringify(currentUser));
  localStorage.setItem('adminSessionExpiry', sessionExpiry.toString());
  
  logActivity('login', 'User logged in successfully');
  showDashboard();
  updateUserDisplay();
  clearErrors();
}

function logout() {
  if (currentUser) {
    logActivity('logout', 'User logged out');
  }
  
  currentUser = null;
  localStorage.removeItem('adminUser');
  localStorage.removeItem('adminSessionExpiry');
  
  document.getElementById('loginContainer').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
  
  // Clear forms
  document.getElementById('loginForm').reset();
  document.getElementById('signupForm').reset();
  showLogin();
  clearErrors();
}

function showError(elementId, message) {
  const errorElement = document.getElementById(elementId);
  if (errorElement) {
    errorElement.textContent = message;
    errorElement.style.display = 'block';
  }
}

function clearErrors() {
  document.querySelectorAll('.error-message').forEach(el => {
    el.textContent = '';
    el.style.display = 'none';
  });
}

// Activity Logging Display Functions
function loadActivityLog() {
  updateActivityDisplay();
  populateUserFilter();
}

function updateActivityDisplay() {
  const container = document.getElementById('activityLogList');
  if (!container) return;
  
  if (activityLog.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No activity recorded yet</div>';
    return;
  }
  
  const filteredLog = getFilteredActivityLog();
  
  container.innerHTML = filteredLog.map(activity => {
    const time = new Date(activity.timestamp).toLocaleString();
    const timeAgo = getTimeAgo(new Date(activity.timestamp));
    
    return `
      <div class="activity-item" style="border-left: 4px solid ${getActivityColor(activity.type)}; padding: 12px; margin-bottom: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: between; align-items: start;">
          <div style="flex: 1;">
            <strong>${activity.userFullName || activity.user}</strong> 
            <span style="color: #666;">(${activity.type})</span>
            <div style="margin: 5px 0; color: #333;">${activity.action}</div>
            ${activity.details ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">${activity.details}</div>` : ''}
          </div>
          <div style="text-align: right; font-size: 12px; color: #999;">
            <div>${timeAgo}</div>
            <div>${time}</div>
            <div>${activity.deviceInfo}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  updateActivityStats();
}

function getActivityColor(type) {
  const colors = {
    login: '#28a745',
    logout: '#6c757d', 
    orders: '#007bff',
    customers: '#17a2b8',
    inventory: '#ffc107',
    settings: '#6f42c1',
    security: '#dc3545',
    system: '#6c757d'
  };
  return colors[type] || '#6c757d';
}

function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 30) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

function getFilteredActivityLog() {
  let filtered = [...activityLog];
  
  // Filter by activity type
  const typeFilter = document.getElementById('activityFilter')?.value;
  if (typeFilter && typeFilter !== 'all') {
    filtered = filtered.filter(activity => activity.type === typeFilter);
  }
  
  // Filter by user
  const userFilter = document.getElementById('userFilter')?.value;
  if (userFilter && userFilter !== 'all') {
    filtered = filtered.filter(activity => activity.user === userFilter);
  }
  
  // Filter by date
  const dateFilter = document.getElementById('dateFilter')?.value;
  if (dateFilter) {
    const filterDate = new Date(dateFilter);
    filtered = filtered.filter(activity => {
      const activityDate = new Date(activity.timestamp);
      return activityDate.toDateString() === filterDate.toDateString();
    });
  }
  
  return filtered;
}

function populateUserFilter() {
  const userFilter = document.getElementById('userFilter');
  if (!userFilter) return;
  
  const users = [...new Set(activityLog.map(activity => activity.user))];
  
  userFilter.innerHTML = '<option value="all">All Users</option>' + 
    users.map(user => `<option value="${user}">${user}</option>`).join('');
}

function updateActivityStats() {
  const today = new Date().toDateString();
  const todayActivities = activityLog.filter(activity => 
    new Date(activity.timestamp).toDateString() === today
  );
  
  const activeUsers = [...new Set(activityLog.filter(activity => {
    const activityDate = new Date(activity.timestamp);
    const hourAgo = new Date(Date.now() - 60 * 60 * 1000);
    return activityDate > hourAgo;
  }).map(activity => activity.user))];
  
  const lastActivity = activityLog.length > 0 ? 
    getTimeAgo(new Date(activityLog[0].timestamp)) : 'Never';
  
  document.getElementById('todayActions').textContent = todayActivities.length;
  document.getElementById('activeUsers').textContent = activeUsers.length;
  document.getElementById('lastActivity').textContent = lastActivity;
}

function filterActivityLog() {
  updateActivityDisplay();
}

function exportActivityLog() {
  const filteredLog = getFilteredActivityLog();
  const csvContent = "data:text/csv;charset=utf-8," + 
    "Timestamp,User,Type,Action,Details,Device\n" +
    filteredLog.map(activity => 
      `"${activity.timestamp}","${activity.userFullName || activity.user}","${activity.type}","${activity.action}","${activity.details || ''}","${activity.deviceInfo}"`
    ).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `activity-log-${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  logActivity('system', 'Activity log exported');
}

// Cross-Device Data Synchronization
async function syncDataWithCloud() {
  if (!SYNC_ENABLED || syncInProgress) return;
  
  syncInProgress = true;
  try {
    const dataToSync = {
      adminUsers,
      activityLog: activityLog.slice(0, 500), // Only sync recent activities
      orders,
      customers,
      inventory,
      blockedDates,
      lastSyncTime: new Date().toISOString(),
      deviceInfo: getDeviceInfo(),
      userId: currentUser?.id
    };
    
    const response = await fetch(`${SYNC_SERVER_URL}/sync`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('syncToken')}`
      },
      body: JSON.stringify(dataToSync)
    });
    
    if (response.ok) {
      const syncedData = await response.json();
      
      // Merge synced data intelligently
      mergeCloudData(syncedData);
      
      lastSyncTime = new Date().toISOString();
      localStorage.setItem('lastSyncTime', lastSyncTime);
      
      logActivity('system', 'Data synchronized with cloud successfully');
      showNotification('Data synced across all devices!', 'success');
    } else {
      throw new Error(`Sync failed with status: ${response.status}`);
    }
  } catch (error) {
    console.error('Sync error:', error);
    logActivity('system', 'Cloud sync failed', error.message);
    // Continue working offline
    showNotification('Working offline - will sync when connection is restored', 'warning');
  } finally {
    syncInProgress = false;
  }
}

function mergeCloudData(cloudData) {
  // Smart merge strategy - preserve local changes while updating with cloud data
  
  // Merge orders (keep most recent based on last modified)
  if (cloudData.orders) {
    const mergedOrders = [...orders];
    cloudData.orders.forEach(cloudOrder => {
      const localIndex = mergedOrders.findIndex(o => o.id === cloudOrder.id);
      if (localIndex === -1) {
        mergedOrders.push(cloudOrder);
      } else {
        // Keep the most recently modified version
        if (!mergedOrders[localIndex].lastModified || 
            (cloudOrder.lastModified && cloudOrder.lastModified > mergedOrders[localIndex].lastModified)) {
          mergedOrders[localIndex] = cloudOrder;
        }
      }
    });
    orders = mergedOrders;
    localStorage.setItem('adminOrders', JSON.stringify(orders));
  }
  
  // Similar merge for customers
  if (cloudData.customers) {
    const mergedCustomers = [...customers];
    cloudData.customers.forEach(cloudCustomer => {
      const localIndex = mergedCustomers.findIndex(c => c.id === cloudCustomer.id);
      if (localIndex === -1) {
        mergedCustomers.push(cloudCustomer);
      } else if (!mergedCustomers[localIndex].lastModified || 
                 (cloudCustomer.lastModified && cloudCustomer.lastModified > mergedCustomers[localIndex].lastModified)) {
        mergedCustomers[localIndex] = cloudCustomer;
      }
    });
    customers = mergedCustomers;
    localStorage.setItem('adminCustomers', JSON.stringify(customers));
  }
  
  // Merge inventory
  if (cloudData.inventory) {
    inventory = cloudData.inventory;
    localStorage.setItem('adminInventory', JSON.stringify(inventory));
  }
  
  // Merge blocked dates
  if (cloudData.blockedDates) {
    blockedDates = cloudData.blockedDates;
    localStorage.setItem('adminBlockedDates', JSON.stringify(blockedDates));
  }
  
  // Merge activity log (combine and sort by timestamp)
  if (cloudData.activityLog) {
    const combinedLog = [...activityLog, ...cloudData.activityLog];
    const uniqueLog = combinedLog.filter((activity, index, arr) => 
      arr.findIndex(a => a.id === activity.id) === index
    );
    activityLog = uniqueLog.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    localStorage.setItem('activityLog', JSON.stringify(activityLog));
  }
  
  // Refresh UI
  refreshAllData();
  updateActivityDisplay();
}

// Auto-sync functions
function startAutoSync() {
  // Sync every 5 minutes when user is active
  setInterval(() => {
    if (currentUser && document.visibilityState === 'visible') {
      syncDataWithCloud();
    }
  }, 5 * 60 * 1000);
  
  // Sync when page becomes visible (user switches back to app)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && currentUser) {
      syncDataWithCloud();
    }
  });
  
  // Sync before page unload
  window.addEventListener('beforeunload', () => {
    if (currentUser) {
      navigator.sendBeacon(`${SYNC_SERVER_URL}/quick-sync`, JSON.stringify({
        userId: currentUser.id,
        lastActivity: new Date().toISOString()
      }));
    }
  });
}

// Offline detection and sync queue
let syncQueue = JSON.parse(localStorage.getItem('syncQueue') || '[]');

function queueForSync(action, data) {
  const queueItem = {
    id: Date.now(),
    action,
    data,
    timestamp: new Date().toISOString(),
    userId: currentUser?.id
  };
  
  syncQueue.push(queueItem);
  localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
  
  // Try to process queue if online
  if (navigator.onLine && SYNC_ENABLED) {
    processSyncQueue();
  }
}

async function processSyncQueue() {
  if (syncQueue.length === 0) return;
  
  try {
    const response = await fetch(`${SYNC_SERVER_URL}/process-queue`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('syncToken')}`
      },
      body: JSON.stringify({ queue: syncQueue })
    });
    
    if (response.ok) {
      syncQueue = [];
      localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
      logActivity('system', 'Sync queue processed successfully');
    }
  } catch (error) {
    console.error('Failed to process sync queue:', error);
  }
}

// Network status monitoring
window.addEventListener('online', () => {
  showNotification('Connection restored - syncing data...', 'success');
  if (currentUser) {
    syncDataWithCloud();
    processSyncQueue();
  }
});

window.addEventListener('offline', () => {
  showNotification('Working offline - changes will sync when connection is restored', 'warning');
});

function showDashboard() {
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  refreshAllData();
  loadDashboardData();
  initializeCharts();
  updateLastUpdateTime();
  showNotification('Welcome to the admin dashboard!', 'success');
}

function switchTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  
  // Update tab content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(tabName).classList.add('active');
  
  // Load specific tab data
  switch(tabName) {
    case 'calendar':
      generateCalendar();
      break;
    case 'analytics':
      updateAnalyticsCharts();
      break;
    case 'inventory':
      loadInventoryData();
      break;
    case 'finances':
      loadFinancialData();
      break;
  }
}

function loadDashboardData() {
  updateOverviewStats();
  loadOrdersTable();
  loadCustomersTable();
}

function updateOverviewStats() {
  const today = new Date();
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const weekStart = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  // Today's stats
  const todayOrders = orders.filter(o => new Date(o.date) >= todayStart);
  document.getElementById('todayOrders').textContent = todayOrders.length;
  document.getElementById('todayRevenue').textContent = '£' + todayOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0).toFixed(2);
  
  // Week's stats
  const weekOrders = orders.filter(o => new Date(o.date) >= weekStart);
  document.getElementById('weekOrders').textContent = weekOrders.length;
  document.getElementById('weekRevenue').textContent = '£' + weekOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0).toFixed(2);
  
  // Other stats
  document.getElementById('pendingOrders').textContent = orders.filter(o => o.status === 'pending').length;
  document.getElementById('totalCustomers').textContent = customers.length;
  document.getElementById('newCustomers').textContent = customers.filter(c => new Date(c.joinDate) >= weekStart).length;
  
  const avgOrder = weekOrders.length > 0 ? weekOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0) / weekOrders.length : 0;
  document.getElementById('avgOrderValue').textContent = '£' + avgOrder.toFixed(2);
  
  const monthlyTotal = orders.filter(o => {
    const orderDate = new Date(o.date);
    return orderDate.getMonth() === today.getMonth() && orderDate.getFullYear() === today.getFullYear();
  }).reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
  document.getElementById('monthlyRevenue').textContent = '£' + monthlyTotal.toFixed(2);
  
  const outstandingPayments = orders.filter(o => o.paymentStatus !== 'paid').reduce((sum, o) => sum + parseFloat(o.remaining || 0), 0);
  document.getElementById('outstandingPayments').textContent = '£' + outstandingPayments.toFixed(2);
}

function loadOrdersTable() {
  const tbody = document.getElementById('ordersTableBody');
  tbody.innerHTML = '';
  
  orders.forEach(order => {
    const deliveryMethod = order.deliveryMethod || 'delivery';
    const methodIcon = deliveryMethod === 'delivery' ? '🚚' : '🏪';
    
    // Calculate days until delivery
    const today = new Date();
    const deliveryDate = new Date(order.deliveryDate);
    const daysUntil = Math.ceil((deliveryDate - deliveryDate) / (1000 * 60 * 60 * 24));
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>#${order.id}</td>
      <td>${order.customerName}<br><small>${order.customerEmail || ''}</small></td>
      <td>${order.items}</td>
      <td>£${order.total}<br><small>${methodIcon} ${deliveryMethod}</small></td>
      <td><span class="status-badge status-${order.status}">${order.status}</span></td>
      <td><span class="status-badge status-${order.paymentStatus}">${order.paymentStatus}</span></td>
      <td>${order.deliveryDate}<br><small>${order.reminderSent ? '✅ Reminder sent' : '📅 No reminder'}</small></td>
      <td>
        <button class="action-btn btn-info" onclick="viewOrder('${order.id}')">👁️</button>
        <button class="action-btn btn-success" onclick="updateOrderStatus('${order.id}', 'confirmed')">✅</button>
        <button class="action-btn btn-warning" onclick="updateOrderStatus('${order.id}', 'completed')">🎯</button>
        <button class="action-btn btn-primary" onclick="sendManualReminder('${order.id}')" title="Send Reminder">📱</button>
        <button class="action-btn btn-danger" onclick="deleteOrder('${order.id}')">🗑️</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function loadCustomersTable() {
  const tbody = document.getElementById('customersTableBody');
  tbody.innerHTML = '';
  
  customers.forEach(customer => {
    const customerOrders = orders.filter(o => o.customerEmail === customer.email);
    const totalSpent = customerOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
    const lastOrder = customerOrders.length > 0 ? new Date(Math.max(...customerOrders.map(o => new Date(o.date)))).toLocaleDateString() : 'Never';
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${customer.name}</td>
      <td>${customer.email}</td>
      <td>${customer.phone}</td>
      <td>${customerOrders.length}</td>
      <td>£${totalSpent.toFixed(2)}</td>
      <td>${lastOrder}</td>
      <td>${customer.loyaltyPoints || 0}</td>
      <td>
        <button class="action-btn btn-info" onclick="viewCustomer('${customer.email}')">👁️</button>
        <button class="action-btn btn-primary" onclick="contactCustomer('${customer.email}')">📞</button>
        <button class="action-btn btn-danger" onclick="deleteCustomer('${customer.email}')">🗑️</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function generateCalendar() {
  const calendar = document.getElementById('orderCalendar');
  calendar.innerHTML = '';
  
  // Add headers
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  days.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-header';
    header.textContent = day;
    calendar.appendChild(header);
  });
  
  // Add calendar days
  const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  for (let i = 0; i < 42; i++) {
    const cellDate = new Date(startDate);
    cellDate.setDate(startDate.getDate() + i);
    
    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    cell.textContent = cellDate.getDate();
    
    // Check if this date has orders
    const dateStr = cellDate.toISOString().split('T')[0];
    const dayOrders = orders.filter(o => o.deliveryDate === dateStr);
    
    if (dayOrders.length > 0) {
      cell.classList.add('has-orders');
      const dot = document.createElement('div');
      dot.className = 'order-dot';
      cell.appendChild(dot);
    }
    
    // Check if this date is blocked
    if (blockedDates.includes(dateStr)) {
      cell.classList.add('blocked');
    }
    
    cell.addEventListener('click', () => showDayDetails(dateStr));
    calendar.appendChild(cell);
  }
  
  // Update month display
  document.getElementById('currentMonth').textContent = 
    currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
}

function initializeCharts() {
  // Revenue Chart
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  charts.revenue = new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: getLast7Days(),
      datasets: [{
        label: 'Daily Revenue',
        data: generateRevenueData(),
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '£' + value;
            }
          }
        }
      }
    }
  });
}

function updateAnalyticsCharts() {
  // Sales Chart
  const salesCtx = document.getElementById('salesChart')?.getContext('2d');
  if (salesCtx && !charts.sales) {
    charts.sales = new Chart(salesCtx, {
      type: 'bar',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'Monthly Sales',
          data: [1200, 1900, 3000, 2100, 3200, 2800],
          backgroundColor: 'rgba(102, 126, 234, 0.8)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
  
  // Product Chart
  const productCtx = document.getElementById('productChart')?.getContext('2d');
  if (productCtx && !charts.product) {
    charts.product = new Chart(productCtx, {
      type: 'doughnut',
      data: {
        labels: ['Shortbread Delight', 'Cupcakes', 'Brownies', 'Biscuits'],
        datasets: [{
          data: [35, 25, 20, 20],
          backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
}

function generateSampleData() {
  // Reset all data to empty/zero state
  resetAllAdminData();
}

function resetAllAdminData() {
  // Clear all stored data
  orders = [];
  customers = [];
  inventory = [];
  blockedDates = [];
  activityLog = [];
  
  // Save empty data to localStorage
  localStorage.setItem('adminOrders', JSON.stringify(orders));
  localStorage.setItem('adminCustomers', JSON.stringify(customers));
  localStorage.setItem('adminInventory', JSON.stringify(inventory));
  localStorage.setItem('adminBlockedDates', JSON.stringify(blockedDates));
  localStorage.setItem('activityLog', JSON.stringify(activityLog));
  
  // Keep admin users but clear regular users (keep only the default admin)
  const defaultAdmin = adminUsers.find(u => u.username === 'admin');
  if (defaultAdmin) {
    adminUsers = [defaultAdmin];
  } else {
    adminUsers = [];
  }
  localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
  
  // Log the reset action
  logActivity('system', 'All admin data reset to zero', 'Complete data reset performed');
  
  console.log('✅ All admin data has been reset to zero');
}

// Enhanced data synchronization functions
function syncDataFromStorage() {
  // Load all data from localStorage
  orders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
  customers = JSON.parse(localStorage.getItem('adminCustomers') || '[]');
  inventory = JSON.parse(localStorage.getItem('adminInventory') || '[]');
  blockedDates = JSON.parse(localStorage.getItem('adminBlockedDates') || '[]');
  activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
  adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '[]');
  
  // Ensure default admin exists
  ensureDefaultAdmin();
  
  // Refresh all displays
  refreshAllDisplays();
  
  console.log('✅ Data synchronized from storage');
}

function saveAllDataInstantly() {
  // Save all data immediately to localStorage
  localStorage.setItem('adminOrders', JSON.stringify(orders));
  localStorage.setItem('adminCustomers', JSON.stringify(customers));
  localStorage.setItem('adminInventory', JSON.stringify(inventory));
  localStorage.setItem('adminBlockedDates', JSON.stringify(blockedDates));
  localStorage.setItem('activityLog', JSON.stringify(activityLog));
  localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
  
  // Update last save timestamp
  localStorage.setItem('lastDataSave', new Date().toISOString());
  
  // Broadcast to other tabs/windows
  broadcastDataUpdate();
  
  // Cache for offline use
  cacheDataForPWA();
  
  console.log('✅ All data saved instantly across devices');
}

function ensureDefaultAdmin() {
  // Make sure default admin always exists
  const defaultAdmin = adminUsers.find(u => u.username === 'admin');
  if (!defaultAdmin) {
    adminUsers.push({
      id: 'admin-default',
      username: 'admin',
      password: 'cupcakes2025',
      email: 'admin@cupcakesontheavenue.com',
      role: 'Admin',
      createdAt: new Date().toISOString(),
      isActive: true
    });
    localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
  }
}

function refreshAllDisplays() {
  // Refresh all UI displays with current data
  try {
    if (typeof renderOrdersChart === 'function') renderOrdersChart();
    if (typeof renderCustomersChart === 'function') renderCustomersChart();
    if (typeof renderRevenueChart === 'function') renderRevenueChart();
    if (typeof updateDashboardStats === 'function') updateDashboardStats();
    if (typeof renderInventoryTable === 'function') renderInventoryTable();
    if (typeof renderCustomersTable === 'function') renderCustomersTable();
    if (typeof renderOrdersTable === 'function') renderOrdersTable();
    if (typeof displayActivityLog === 'function') displayActivityLog();
    updateLastUpdateTime();
  } catch (error) {
    console.log('Some displays not ready yet, will refresh when loaded');
  }
}

function broadcastDataUpdate() {
  // Broadcast to other tabs/windows using BroadcastChannel
  if ('BroadcastChannel' in window) {
    const channel = new BroadcastChannel('admin-data-sync');
    channel.postMessage({
      type: 'DATA_UPDATED',
      timestamp: new Date().toISOString(),
      data: {
        orders: orders.length,
        customers: customers.length,
        inventory: inventory.length
      }
    });
  }
}

function setupAutoSync() {
  // Listen for data updates from other tabs/windows
  if ('BroadcastChannel' in window) {
    const channel = new BroadcastChannel('admin-data-sync');
    channel.onmessage = (event) => {
      if (event.data.type === 'DATA_UPDATED') {
        console.log('📡 Data update received from another device/tab');
        syncDataFromStorage();
        showSyncNotification();
      }
    };
  }
  
  // Auto-save every 30 seconds
  setInterval(() => {
    saveAllDataInstantly();
  }, 30000);
  
  // Save when page visibility changes (user switches tabs)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      saveAllDataInstantly();
    } else {
      // When page becomes visible, sync latest data
      syncDataFromStorage();
    }
  });
  
  // Save before page unload
  window.addEventListener('beforeunload', () => {
    saveAllDataInstantly();
  });
  
  console.log('✅ Auto-sync setup complete');
}

function showSyncNotification() {
  // Show a brief notification that data was synced
  const notification = document.createElement('div');
  notification.innerHTML = '📡 Data synchronized from other device';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #667eea;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    z-index: 10000;
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.3s;
  `;
  
  document.body.appendChild(notification);
  
  // Fade in
  setTimeout(() => {
    notification.style.opacity = '1';
  }, 100);
  
  // Fade out and remove
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Utility functions
function getLast7Days() {
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
  }
  return days;
}

function generateRevenueData() {
  return [125, 89, 156, 203, 178, 245, 190];
}

function updateLastUpdateTime() {
  document.getElementById('lastUpdate').textContent = 
    'Last updated: ' + new Date().toLocaleTimeString();
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
    <p>${message}</p>
  `;
  
  document.getElementById('notificationPanel').appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

function refreshAllData() {
  loadDashboardData();
  updateLastUpdateTime();
  showNotification('All data refreshed successfully!', 'success');
}

// Modal functions
function showModal(title, content) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = content;
  document.getElementById('modal').style.display = 'block';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

// Action functions
function viewOrder(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (order) {
    const content = `
      <h4>Order Details</h4>
      <p><strong>Customer:</strong> ${order.customerName}</p>
      <p><strong>Email:</strong> ${order.customerEmail}</p>
      <p><strong>Items:</strong> ${order.items}</p>
      <p><strong>Total:</strong> £${order.total}</p>
      <p><strong>Status:</strong> ${order.status}</p>
      <p><strong>Payment:</strong> ${order.paymentStatus}</p>
      <p><strong>Delivery Date:</strong> ${order.deliveryDate}</p>
    `;
    showModal('Order #' + orderId, content);
  }
}

function updateOrderStatus(orderId, newStatus) {
  const orderIndex = orders.findIndex(o => o.id === orderId);
  if (orderIndex !== -1) {
    const order = orders[orderIndex];
    const previousStatus = order.status;
    order.status = newStatus;
    order.lastUpdated = new Date().toISOString();
    
    localStorage.setItem('adminOrders', JSON.stringify(orders));
    loadOrdersTable();
    showNotification(`Order ${orderId} status updated to ${newStatus}`, 'success');
    
    // Send status update email to customer
    if (order.customerEmail && previousStatus !== newStatus) {
      sendOrderStatusEmail(order, newStatus);
    }
  }
}

async function sendOrderStatusEmail(order, newStatus) {
  try {
    // Prepare order data for email
    const orderData = {
      orderNumber: order.id,
      status: newStatus,
      items: order.orderItems ? order.orderItems.split('\n').map(item => {
        const match = item.match(/(.+?)\s*x(\d+)\s*-\s*£([\d.]+)/);
        if (match) {
          return {
            name: match[1].trim(),
            quantity: parseInt(match[2]),
            price: parseFloat(match[3]).toFixed(2)
          };
        }
        return { name: item.trim(), quantity: 1, price: '0.00' };
      }) : [],
      total: `£${order.totalPrice || order.total || '0.00'}`,
      deliveryMethod: order.deliveryMethod || (order.delivery === 'Market Collection' ? 'Market Collection' : 'Home Delivery'),
      deliveryInfo: order.delivery === 'Market Collection' ? 
        `Saturday Market Collection on ${new Date(order.date).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}` :
        `${order.address || 'Home Delivery'} on ${new Date(order.date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`,
      date: new Date(order.date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
      address: order.delivery !== 'Market Collection' ? order.address : null
    };

    const response = await fetch('https://sumup-backend-lemon.vercel.app/api/send-customer-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        emailType: 'statusUpdate',
        customerData: {
          name: order.customerName,
          email: order.customerEmail
        },
        orderData: orderData
      })
    });
    
    if (response.ok) {
      console.log(`✅ Status update email sent to ${order.customerEmail}`);
      showNotification(`Status update email sent to customer`, 'success');
    } else {
      console.warn('⚠️ Status update email failed');
      showNotification(`Email notification failed`, 'warning');
    }
  } catch (error) {
    console.warn('⚠️ Status update email error:', error);
    showNotification(`Email notification error`, 'warning');
  }
}

function deleteOrder(orderId) {
  if (confirm('Are you sure you want to delete this order?')) {
    orders = orders.filter(o => o.id !== orderId);
    localStorage.setItem('adminOrders', JSON.stringify(orders));
    loadOrdersTable();
    showNotification('Order deleted successfully', 'success');
  }
}

function sendPushNotification() {
  const type = document.getElementById('notificationType').value;
  const message = document.getElementById('notificationMessage').value;
  
  if (message.trim()) {
    // In a real app, this would send to your notification service
    showNotification('Push notification sent to all app users!', 'success');
    document.getElementById('notificationMessage').value = '';
  } else {
    showNotification('Please enter a message', 'error');
  }
}

function testDiscordWebhook() {
  const webhookUrl = document.getElementById('discordWebhook').value;
  
  fetch(webhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      content: '🧪 Test from Advanced Admin Dashboard - All systems operational! 🧁',
      username: 'Cupcakes Admin Pro',
      avatar_url: 'https://cdn.discordapp.com/emojis/1028516711491154031.webp'
    })
  })
  .then(response => {
    if (response.ok) {
      showNotification('Discord webhook test successful!', 'success');
    } else {
      showNotification('Discord webhook test failed', 'error');
    }
  })
  .catch(error => {
    showNotification('Discord webhook error: ' + error.message, 'error');
  });
}

// Add more functions as needed for all the features...
function filterOrders() {
  const search = document.getElementById('orderSearch').value.toLowerCase();
  const filter = document.getElementById('orderFilter').value;
  
  const rows = document.querySelectorAll('#ordersTableBody tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    const status = row.querySelector('.status-badge').textContent.toLowerCase();
    
    const matchesSearch = text.includes(search);
    const matchesFilter = !filter || status.includes(filter);
    
    row.style.display = matchesSearch && matchesFilter ? '' : 'none';
  });
}

function filterCustomers() {
  const search = document.getElementById('customerSearch').value.toLowerCase();
  
  const rows = document.querySelectorAll('#customersTableBody tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(search) ? '' : 'none';
  });
}

// Calendar functions
function prevMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  generateCalendar();
}

function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  generateCalendar();
}

function showDayDetails(dateStr) {
  const dayOrders = orders.filter(o => o.deliveryDate === dateStr);
  let content = `<h4>Orders for ${dateStr}</h4>`;
  
  if (dayOrders.length > 0) {
    content += '<ul>';
    dayOrders.forEach(order => {
      const deliveryMethod = order.deliveryMethod || 'delivery';
      const methodIcon = deliveryMethod === 'delivery' ? '🚚' : '🏪';
      const methodText = deliveryMethod === 'delivery' ? 'Delivery' : 'Market Collection';
      content += `<li><strong>${order.customerName}</strong><br>
                      ${order.items}<br>
                      <span style="color: #667eea;">${methodIcon} ${methodText} - £${order.total}</span></li>`;
    });
    content += '</ul>';
  } else {
    content += '<p>No orders for this date.</p>';
  }
  
  // Add day-specific info
  const dayOfWeek = new Date(dateStr).getDay();
  if (dayOfWeek === 6) { // Saturday
    content += '<hr><p style="color: #667eea; font-weight: bold;">📍 Saturday: Market Collection Available (8 AM - 2 PM)</p>';
  } else if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday-Friday
    content += '<hr><p style="color: #667eea; font-weight: bold;">🚚 Weekday: Home Delivery Available</p>';
  } else { // Sunday
    content += '<hr><p style="color: #999;">📅 Sunday: No services available</p>';
  }
  
  showModal('Day Details', content);
}

// Calendar Sync Functions
function syncCalendarWithOrders() {
  // Sync admin calendar with shop orders from localStorage
  const shopOrders = JSON.parse(localStorage.getItem('shopOrders') || '[]');
  const webOrders = JSON.parse(localStorage.getItem('webOrders') || '[]');
  
  // Merge shop and web orders into admin system
  shopOrders.forEach(shopOrder => {
    const existingOrder = orders.find(o => o.id === shopOrder.id);
    if (!existingOrder) {
      orders.push({
        id: shopOrder.id || `WEB-${Date.now()}`,
        customerName: shopOrder.name,
        customerEmail: shopOrder.email,
        customerPhone: shopOrder.mobile,
        customerAddress: shopOrder.address,
        deliveryMethod: shopOrder.deliveryMethod || 'delivery',
        deliveryFee: shopOrder.deliveryFee || 0,
        items: shopOrder.items.map(item => `${item.name} x${item.quantity}`).join(', '),
        subtotal: shopOrder.subtotal ? shopOrder.subtotal.toFixed(2) : (shopOrder.total - (shopOrder.deliveryFee || 0)).toFixed(2),
        total: shopOrder.total.toFixed(2),
        status: 'pending',
        paymentStatus: 'unpaid',
        deliveryDate: shopOrder.deliveryDate || getTomorrowDate(),
        date: new Date().toISOString().split('T')[0],
        deposit: (shopOrder.total * 0.25).toFixed(2),
        remaining: (shopOrder.total * 0.75).toFixed(2),
        notes: shopOrder.notes || '',
        source: 'website'
      });
      
      // Add customer if new
      addCustomerFromOrder(shopOrder);
    }
  });
  
  // Save updated orders
  localStorage.setItem('adminOrders', JSON.stringify(orders));
  generateCalendar();
  loadOrdersTable();
  showNotification('Calendar synced with website orders!', 'success');
}

function getTomorrowDate() {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 7); // 7 days minimum lead time
  return tomorrow.toISOString().split('T')[0];
}

// Customer Management Functions
function addCustomerFromOrder(orderData) {
  const existingCustomer = customers.find(c => c.email === orderData.email);
  
  if (!existingCustomer) {
    const newCustomer = {
      name: orderData.name,
      email: orderData.email,
      phone: orderData.mobile || '',
      address: orderData.address || '',
      joinDate: new Date().toISOString().split('T')[0],
      loyaltyPoints: 10, // Welcome points
      notes: '',
      preferences: [],
      communicationHistory: [],
      lastContact: null
    };
    
    customers.push(newCustomer);
    
    // Instantly save and sync all data across devices
    saveAllDataInstantly();
    
    updateCustomerDropdown();
    showNotification(`New customer added: ${newCustomer.name}`, 'success');
  }
}

function updateCustomerDropdown() {
  const dropdown = document.getElementById('individualCustomer');
  if (dropdown) {
    dropdown.innerHTML = '<option value="">Choose a customer...</option>';
    customers.forEach(customer => {
      const option = document.createElement('option');
      option.value = customer.email;
      option.textContent = `${customer.name} - ${customer.email}`;
      dropdown.appendChild(option);
    });
  }
}

// Individual Customer Communication
function contactIndividualCustomer() {
  const customerEmail = document.getElementById('individualCustomer').value;
  const method = document.getElementById('contactMethod').value;
  const message = document.getElementById('individualMessage').value;
  
  if (!customerEmail || !message.trim()) {
    showNotification('Please select a customer and enter a message', 'error');
    return;
  }
  
  const customer = customers.find(c => c.email === customerEmail);
  if (!customer) {
    showNotification('Customer not found', 'error');
    return;
  }
  
  // Record communication
  const communication = {
    date: new Date().toISOString(),
    customer: customer.name,
    email: customerEmail,
    method: method,
    message: message,
    status: 'sent',
    sentBy: currentUser.username
  };
  
  // Add to customer's communication history
  if (!customer.communicationHistory) {
    customer.communicationHistory = [];
  }
  customer.communicationHistory.push(communication);
  customer.lastContact = new Date().toISOString().split('T')[0];
  
  // Add to global communication history
  let commHistory = JSON.parse(localStorage.getItem('communicationHistory') || '[]');
  commHistory.unshift(communication);
  localStorage.setItem('communicationHistory', JSON.stringify(commHistory));
  
  // Save updated customer data
  localStorage.setItem('adminCustomers', JSON.stringify(customers));
  
  // Send notification based on method
  switch(method) {
    case 'push':
      sendPushToCustomer(customer, message);
      break;
    case 'email':
      sendEmailToCustomer(customer, message);
      break;
    case 'sms':
      sendSMSToCustomer(customer, message);
      break;
    case 'call':
      initiatePhoneCall(customer, message);
      break;
  }
  
  // Clear form and update history
  document.getElementById('individualMessage').value = '';
  loadCommunicationHistory();
  showNotification(`${method.toUpperCase()} sent to ${customer.name}`, 'success');
}

function sendPushToCustomer(customer, message) {
  // In a real app, this would send a targeted push notification
  console.log(`Push notification to ${customer.email}:`, message);
  
  // Simulate sending to their browser if they have the PWA installed
  if ('serviceWorker' in navigator && 'PushManager' in window) {
    // This would be handled by your service worker and push service
    showNotification(`Push notification queued for ${customer.name}`, 'info');
  }
}

function sendEmailToCustomer(customer, message) {
  // In a real app, this would integrate with your email service
  console.log(`Email to ${customer.email}:`, message);
  showNotification(`Email queued for ${customer.name}`, 'info');
}

function sendSMSToCustomer(customer, message) {
  // In a real app, this would integrate with SMS service like Twilio
  console.log(`SMS to ${customer.phone}:`, message);
  showNotification(`SMS queued for ${customer.name}`, 'info');
}

function initiatePhoneCall(customer, message) {
  // Open phone dialer with customer's number
  if (customer.phone) {
    window.open(`tel:${customer.phone}`);
    showNotification(`Call initiated to ${customer.name} (${customer.phone})`, 'info');
  } else {
    showNotification('No phone number on file for this customer', 'error');
  }
}

function viewCustomerHistory() {
  const customerEmail = document.getElementById('individualCustomer').value;
  if (!customerEmail) {
    showNotification('Please select a customer first', 'error');
    return;
  }
  
  const customer = customers.find(c => c.email === customerEmail);
  if (!customer) {
    showNotification('Customer not found', 'error');
    return;
  }
  
  const customerOrders = orders.filter(o => o.customerEmail === customerEmail);
  const commHistory = customer.communicationHistory || [];
  
  let content = `
    <h4>Customer Profile: ${customer.name}</h4>
    <p><strong>Email:</strong> ${customer.email}</p>
    <p><strong>Phone:</strong> ${customer.phone || 'Not provided'}</p>
    <p><strong>Address:</strong> ${customer.address || 'Not provided'}</p>
    <p><strong>Join Date:</strong> ${customer.joinDate}</p>
    <p><strong>Loyalty Points:</strong> ${customer.loyaltyPoints || 0}</p>
    <p><strong>Total Orders:</strong> ${customerOrders.length}</p>
    <p><strong>Total Spent:</strong> £${customerOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0).toFixed(2)}</p>
    
    <h5 style="margin-top: 20px;">Recent Orders</h5>
    <ul>
  `;
  
  customerOrders.slice(0, 5).forEach(order => {
    content += `<li>${order.date} - ${order.items} (£${order.total}) - ${order.status}</li>`;
  });
  
  content += `</ul><h5 style="margin-top: 20px;">Communication History</h5><ul>`;
  
  commHistory.slice(0, 10).forEach(comm => {
    const date = new Date(comm.date).toLocaleDateString();
    content += `<li>${date} - ${comm.method.toUpperCase()}: ${comm.message}</li>`;
  });
  
  content += '</ul>';
  showModal('Customer History', content);
}

function loadCommunicationHistory() {
  const commHistory = JSON.parse(localStorage.getItem('communicationHistory') || '[]');
  const tbody = document.getElementById('communicationHistory');
  
  if (tbody) {
    tbody.innerHTML = '';
    commHistory.slice(0, 20).forEach(comm => {
      const row = document.createElement('tr');
      const date = new Date(comm.date).toLocaleDateString();
      row.innerHTML = `
        <td>${date}</td>
        <td>${comm.customer}</td>
        <td><span class="status-badge status-${comm.method}">${comm.method.toUpperCase()}</span></td>
        <td>${comm.message.length > 50 ? comm.message.substring(0, 50) + '...' : comm.message}</td>
        <td><span class="status-badge status-${comm.status}">${comm.status}</span></td>
      `;
      tbody.appendChild(row);
    });
  }
}

// Enhanced Data Sync Functions
function exportCustomerData() {
  const data = {
    customers: customers,
    orders: orders,
    communicationHistory: JSON.parse(localStorage.getItem('communicationHistory') || '[]'),
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `customer-data-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('Customer data exported successfully!', 'success');
}

function importWebOrderData() {
  // This function would be called periodically or manually to sync with web orders
  syncCalendarWithOrders();
}

// Enhanced order functions with delivery date
function addOrder() {
  const content = `
    <h4>Add New Order</h4>
    <form id="newOrderForm">
      <div class="form-group">
        <label>Customer Name</label>
        <input type="text" class="form-control" id="newOrderName" required>
      </div>
      <div class="form-group">
        <label>Customer Email</label>
        <input type="email" class="form-control" id="newOrderEmail" required>
      </div>
      <div class="form-group">
        <label>Customer Phone</label>
        <input type="tel" class="form-control" id="newOrderPhone">
      </div>
      <div class="form-group">
        <label>Items</label>
        <textarea class="form-control" id="newOrderItems" rows="3" placeholder="List items ordered..." required></textarea>
      </div>
      <div class="form-group">
        <label>Total Amount (£)</label>
        <input type="number" class="form-control" id="newOrderTotal" step="0.01" required>
      </div>
      <div class="form-group">
        <label>Delivery Date</label>
        <input type="date" class="form-control" id="newOrderDeliveryDate" required min="${getTomorrowDate()}">
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea class="form-control" id="newOrderNotes" rows="2" placeholder="Special instructions..."></textarea>
      </div>
      <button type="submit" class="action-btn btn-success">Add Order</button>
    </form>
  `;
  
  showModal('Add New Order', content);
  
  // Add form submission handler
  document.getElementById('newOrderForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const newOrder = {
      id: `ADM-${Date.now()}`,
      customerName: document.getElementById('newOrderName').value,
      customerEmail: document.getElementById('newOrderEmail').value,
      customerPhone: document.getElementById('newOrderPhone').value,
      items: document.getElementById('newOrderItems').value,
      total: document.getElementById('newOrderTotal').value,
      status: 'pending',
      paymentStatus: 'unpaid',
      deliveryDate: document.getElementById('newOrderDeliveryDate').value,
      date: new Date().toISOString().split('T')[0],
      deposit: (parseFloat(document.getElementById('newOrderTotal').value) * 0.25).toFixed(2),
      remaining: (parseFloat(document.getElementById('newOrderTotal').value) * 0.75).toFixed(2),
      notes: document.getElementById('newOrderNotes').value,
      source: 'admin'
    };
    
    orders.push(newOrder);
    
    // Instantly save and sync all data across devices
    saveAllDataInstantly();
    
    // Log activity
    logActivity('orders', 'New order created', `Order #${newOrder.id} for ${newOrder.customerName} - £${newOrder.total}`);
    
    // Add customer if new
    addCustomerFromOrder({
      name: newOrder.customerName,
      email: newOrder.customerEmail,
      mobile: newOrder.customerPhone
    });
    
    loadOrdersTable();
    generateCalendar();
    closeModal();
    showNotification('Order added successfully!', 'success');
  });
}

// Initialize enhanced functions when dashboard loads
function initializeEnhancedFeatures() {
  updateCustomerDropdown();
  loadCommunicationHistory();
  
  // Auto-sync with web orders every 30 seconds
  setInterval(() => {
    if (currentUser && document.getElementById('dashboard').style.display === 'block') {
      importWebOrderData();
    }
  }, 30000);
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
  const modal = document.getElementById('modal');
  if (e.target === modal) {
    closeModal();
  }
});

// Auto-refresh every 5 minutes
setInterval(() => {
  if (currentUser && document.getElementById('dashboard').style.display === 'block') {
    refreshAllData();
    checkUpcomingOrdersForNotifications();
  }
}, 300000);

// Automatic notification system for upcoming orders
function checkUpcomingOrdersForNotifications() {
  const today = new Date();
  
  orders.forEach(order => {
    const deliveryDate = new Date(order.deliveryDate);
    const daysUntil = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
    
    // Send 3-day reminder if not already sent
    if (daysUntil === 3 && !order.reminderSent && order.status !== 'completed' && order.status !== 'cancelled') {
      sendAutomaticReminder(order);
      order.reminderSent = true;
      localStorage.setItem('adminOrders', JSON.stringify(orders));
    }
  });
}

function sendAutomaticReminder(order) {
  const deliveryMethod = order.deliveryMethod || 'delivery';
  const methodText = deliveryMethod === 'delivery' ? 'delivery' : 'collection from Highworth Market';
  
  const message = `Hi ${order.customerName}! Your order #${order.id} is scheduled for ${methodText} in 3 days (${order.deliveryDate}). Any last minute changes? Please contact us soon! 🧁`;
  
  // Send email reminder to customer
  sendReminderEmail(order);
  
  // Send push notification to customer
  sendPushToCustomer({
    name: order.customerName,
    email: order.customerEmail,
    phone: order.customerPhone
  }, message);
  
  // Log in communication history
  const communication = {
    date: new Date().toISOString(),
    customer: order.customerName,
    email: order.customerEmail,
    method: 'automatic-email-push',
    message: message,
    status: 'sent',
    sentBy: 'system',
    orderId: order.id
  };
  
  let commHistory = JSON.parse(localStorage.getItem('communicationHistory') || '[]');
  commHistory.unshift(communication);
  localStorage.setItem('communicationHistory', JSON.stringify(commHistory));
  
  // Show admin notification
  showNotification(`� Automatic reminder email and push sent to ${order.customerName} for order #${order.id}`, 'success');
  
  // Send Discord notification to admin
  const webhookUrl = document.getElementById('discordWebhook')?.value;
  if (webhookUrl) {
    fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        content: `🔔 **Automatic Reminder Sent**\n📋 Order: #${order.id}\n👤 Customer: ${order.customerName}\n📅 ${methodText.charAt(0).toUpperCase() + methodText.slice(1)} in 3 days\n💬 Email & Push notification sent`,
        username: 'Order Reminder Bot',
        avatar_url: 'https://cdn.discordapp.com/emojis/1028516711491154031.webp'
      })
    });
  }
}

async function sendReminderEmail(order) {
  try {
    // Prepare order data for reminder email
    const orderData = {
      orderNumber: order.id,
      items: order.orderItems ? order.orderItems.split('\n').map(item => {
        const match = item.match(/(.+?)\s*x(\d+)\s*-\s*£([\d.]+)/);
        if (match) {
          return {
            name: match[1].trim(),
            quantity: parseInt(match[2]),
            price: parseFloat(match[3]).toFixed(2)
          };
        }
        return { name: item.trim(), quantity: 1, price: '0.00' };
      }) : [],
      total: `£${order.totalPrice || order.total || '0.00'}`,
      deliveryMethod: order.deliveryMethod || (order.delivery === 'Market Collection' ? 'Market Collection' : 'Home Delivery'),
      date: new Date(order.deliveryDate).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
      address: order.delivery !== 'Market Collection' ? order.address : null,
      deliveryTime: order.deliveryTime || null
    };

    const response = await fetch('https://sumup-backend-lemon.vercel.app/api/send-customer-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        emailType: 'reminder',
        customerData: {
          name: order.customerName,
          email: order.customerEmail
        },
        orderData: orderData
      })
    });
    
    if (response.ok) {
      console.log(`✅ Reminder email sent to ${order.customerEmail}`);
    } else {
      console.warn('⚠️ Reminder email failed');
    }
  } catch (error) {
    console.warn('⚠️ Reminder email error:', error);
  }
}

// Manual reminder function for admin use
function sendManualReminder(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  
  const deliveryMethod = order.deliveryMethod || 'delivery';
  const methodText = deliveryMethod === 'delivery' ? 'delivery' : 'collection from Highworth Market';
  
  const content = `
    <h4>Send Reminder for Order #${orderId}</h4>
    <p><strong>Customer:</strong> ${order.customerName}</p>
    <p><strong>Scheduled:</strong> ${methodText} on ${order.deliveryDate}</p>
    
    <form id="reminderForm">
      <div class="form-group">
        <label>Reminder Message</label>
        <textarea class="form-control" id="reminderMessage" rows="4">Hi ${order.customerName}! Your order #${order.id} is scheduled for ${methodText} on ${order.deliveryDate}. Any last minute changes? Please let us know! 🧁</textarea>
      </div>
      
      <div class="form-group">
        <label>Send Method</label>
        <select class="form-control" id="reminderMethod">
          <option value="push">Push Notification</option>
          <option value="email">Email</option>
          <option value="sms">SMS</option>
        </select>
      </div>
      
      <button type="submit" class="action-btn btn-primary">📤 Send Reminder</button>
    </form>
  `;
  
  showModal('Send Order Reminder', content);
  
  document.getElementById('reminderForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const message = document.getElementById('reminderMessage').value;
    const method = document.getElementById('reminderMethod').value;
    
    // Send the reminder
    const customer = {
      name: order.customerName,
      email: order.customerEmail,
      phone: order.customerPhone
    };
    
    switch(method) {
      case 'push':
        sendPushToCustomer(customer, message);
        break;
      case 'email':
        sendEmailToCustomer(customer, message);
        break;
      case 'sms':
        sendSMSToCustomer(customer, message);
        break;
    }
    
    // Log the communication
    const communication = {
      date: new Date().toISOString(),
      customer: order.customerName,
      email: order.customerEmail,
      method: method,
      message: message,
      status: 'sent',
      sentBy: currentUser.username,
      orderId: order.id
    };
    
    let commHistory = JSON.parse(localStorage.getItem('communicationHistory') || '[]');
    commHistory.unshift(communication);
    localStorage.setItem('communicationHistory', JSON.stringify(commHistory));
    
    loadCommunicationHistory();
    closeModal();
    showNotification(`Reminder sent via ${method.toUpperCase()} to ${order.customerName}`, 'success');
  });
}

// Check for upcoming orders every hour
setInterval(checkUpcomingOrdersForNotifications, 60 * 60 * 1000);

// Initialize enhanced features on dashboard load
document.addEventListener('DOMContentLoaded', () => {
  // Add enhanced initialization when tab switches to communications
  const originalSwitchTab = switchTab;
  window.switchTab = function(tabName) {
    originalSwitchTab(tabName);
    if (tabName === 'communications') {
      updateCustomerDropdown();
      loadCommunicationHistory();
    }
  };
  
  // Run initial check for upcoming orders
  setTimeout(() => {
    if (currentUser) {
      checkUpcomingOrdersForNotifications();
    }
  }, 5000);

  // Add debug tab initialization
  const originalSwitchTabForDebug = switchTab;
  window.switchTab = function(tabName) {
    originalSwitchTabForDebug(tabName);
    if (tabName === 'debug') {
      initializeDebugTab();
    }
    if (tabName === 'communications') {
      updateCustomerDropdown();
      loadCommunicationHistory();
    }
  };
});

// Debug & Fallback Functions
function initializeDebugTab() {
  updateDeviceInfo();
  loadPendingEmails();
  loadAdminNotifications();
  runSystemStatusCheck();
}

function updateDeviceInfo() {
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const orientation = window.innerWidth > window.innerHeight ? 'Landscape' : 'Portrait';
  
  document.getElementById('deviceType').textContent = isMobile ? 'Mobile Device' : 'Desktop';
  document.getElementById('screenSize').textContent = `${window.innerWidth} × ${window.innerHeight}`;
  document.getElementById('touchSupport').textContent = touchSupport ? 'Available' : 'Not detected';
  document.getElementById('orientation').textContent = orientation;
}

function runSystemStatusCheck() {
  // Check backend status
  checkBackendStatus();
  
  // Check email system
  checkEmailSystemStatus();
  
  // Check local storage
  checkLocalStorageStatus();
  
  // Check mobile compatibility
  checkMobileCompatibilityStatus();
}

function checkBackendStatus() {
  const statusElement = document.getElementById('backendStatus');
  const BACKEND_BASE = 'https://sumup-backend.vercel.app';
  
  fetch(`${BACKEND_BASE}/api/index`)
    .then(response => {
      const statusDot = statusElement.querySelector('.status-dot');
      const statusText = statusElement.querySelector('span:last-child');
      
      if (response.ok) {
        statusDot.className = 'status-dot status-online';
        statusText.textContent = 'Backend Connection: Online ✅';
      } else {
        statusDot.className = 'status-dot status-warning';
        statusText.textContent = `Backend Connection: Issues (${response.status}) ⚠️`;
        addAdminNotification('⚠️ Backend connection issues detected', 'warning');
      }
    })
    .catch(error => {
      const statusDot = statusElement.querySelector('.status-dot');
      const statusText = statusElement.querySelector('span:last-child');
      statusDot.className = 'status-dot status-offline';
      statusText.textContent = 'Backend Connection: Offline ❌';
      addAdminNotification('❌ Backend connection failed - fallback systems active', 'error');
    });
}

function checkEmailSystemStatus() {
  const statusElement = document.getElementById('emailStatus');
  const statusDot = statusElement.querySelector('.status-dot');
  const statusText = statusElement.querySelector('span:last-child');
  
  // Check if there are pending emails (indicates email system issues)
  const pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  
  if (pendingEmails.length === 0) {
    statusDot.className = 'status-dot status-online';
    statusText.textContent = 'Email System: Working ✅';
  } else {
    statusDot.className = 'status-dot status-warning';
    statusText.textContent = `Email System: ${pendingEmails.length} pending emails ⚠️`;
    addAdminNotification(`📧 ${pendingEmails.length} emails are pending manual processing`, 'warning');
  }
}

function checkLocalStorageStatus() {
  const statusElement = document.getElementById('storageStatus');
  const statusDot = statusElement.querySelector('.status-dot');
  const statusText = statusElement.querySelector('span:last-child');
  
  try {
    const testKey = 'adminTest_' + Date.now();
    localStorage.setItem(testKey, 'test');
    localStorage.removeItem(testKey);
    
    statusDot.className = 'status-dot status-online';
    statusText.textContent = 'Local Storage: Working ✅';
  } catch (error) {
    statusDot.className = 'status-dot status-offline';
    statusText.textContent = 'Local Storage: Error ❌';
    addAdminNotification('❌ Local storage access failed', 'error');
  }
}

function checkMobileCompatibilityStatus() {
  const statusElement = document.getElementById('mobileStatus');
  const statusDot = statusElement.querySelector('.status-dot');
  const statusText = statusElement.querySelector('span:last-child');
  
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const viewportMeta = document.querySelector('meta[name="viewport"]');
  
  if (isMobile || touchSupport || window.innerWidth <= 768) {
    statusDot.className = 'status-dot status-online';
    statusText.textContent = 'Mobile Compatibility: Optimized ✅';
  } else {
    statusDot.className = 'status-dot status-warning';
    statusText.textContent = 'Mobile Compatibility: Desktop mode ⚠️';
  }
}

function loadPendingEmails() {
  const pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  const countElement = document.getElementById('pendingEmailsCount');
  const listElement = document.getElementById('pendingEmailsList');
  
  countElement.textContent = pendingEmails.length;
  
  if (pendingEmails.length === 0) {
    listElement.innerHTML = '<p style="color: #666; text-align: center;">No pending emails 🎉</p>';
    return;
  }
  
  listElement.innerHTML = pendingEmails.map((email, index) => `
    <div class="pending-email-item">
      <div class="pending-email-header">
        <span class="pending-email-type">${email.type}</span>
        <span class="pending-email-time">${new Date(email.timestamp).toLocaleString()}</span>
      </div>
      <div><strong>To:</strong> ${email.data.email || email.data.name}</div>
      <div class="pending-email-preview"><strong>Subject:</strong> ${email.preview.subject}</div>
      <div class="pending-email-preview">${email.preview.body.substring(0, 100)}...</div>
      <div style="margin-top: 8px;">
        <button class="action-btn btn-sm btn-success" onclick="processSingleEmail(${index})">✉️ Send</button>
        <button class="action-btn btn-sm btn-warning" onclick="viewEmailContent(${index})">👁️ View</button>
        <button class="action-btn btn-sm btn-danger" onclick="deletePendingEmail(${index})">🗑️ Delete</button>
      </div>
    </div>
  `).join('');
}

function loadAdminNotifications() {
  const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
  const listElement = document.getElementById('adminNotificationsList');
  
  if (notifications.length === 0) {
    listElement.innerHTML = '<p style="color: #666; text-align: center;">No notifications</p>';
    return;
  }
  
  listElement.innerHTML = notifications
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .slice(0, 20) // Show only last 20
    .map(notification => `
      <div class="notification-item ${notification.read ? '' : 'unread'}">
        <div class="notification-icon">${getNotificationIcon(notification.type)}</div>
        <div class="notification-content">
          <div>${notification.message}</div>
          <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
        </div>
      </div>
    `).join('');
}

function getNotificationIcon(type) {
  switch(type) {
    case 'error': return '❌';
    case 'warning': return '⚠️';
    case 'success': return '✅';
    case 'info': return 'ℹ️';
    default: return '🔔';
  }
}

function addAdminNotification(message, type = 'info') {
  const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
  
  const notification = {
    id: Date.now(),
    message: message,
    type: type,
    timestamp: new Date().toISOString(),
    read: false
  };
  
  notifications.unshift(notification);
  
  // Keep only last 100 notifications
  if (notifications.length > 100) {
    notifications.splice(100);
  }
  
  localStorage.setItem('adminNotifications', JSON.stringify(notifications));
  
  // Update the UI if debug tab is active
  if (document.getElementById('debug').classList.contains('active')) {
    loadAdminNotifications();
  }
  
  // Show popup notification
  showNotification(message, type);
}

function runFullSystemDiagnostic() {
  addAdminNotification('🔍 Running full system diagnostic...', 'info');
  
  // Reset all status indicators to checking
  document.querySelectorAll('.status-dot').forEach(dot => {
    dot.className = 'status-dot status-checking';
  });
  
  // Run checks with delays for better UX
  setTimeout(() => checkBackendStatus(), 500);
  setTimeout(() => checkEmailSystemStatus(), 1000);
  setTimeout(() => checkLocalStorageStatus(), 1500);
  setTimeout(() => checkMobileCompatibilityStatus(), 2000);
  setTimeout(() => updateDeviceInfo(), 2500);
  setTimeout(() => {
    addAdminNotification('✅ System diagnostic completed', 'success');
  }, 3000);
}

function testBackendEndpoints() {
  addAdminNotification('🔌 Testing backend endpoints...', 'info');
  
  const BACKEND_BASE = 'https://sumup-backend.vercel.app';
  const endpoints = [
    { name: 'Health Check', url: `${BACKEND_BASE}/api/index` },
    { name: 'Email API', url: `${BACKEND_BASE}/api/send-customer-email` },
    { name: 'Discord Webhook', url: `${BACKEND_BASE}/api/discord-webhook` }
  ];
  
  endpoints.forEach((endpoint, index) => {
    setTimeout(() => {
      fetch(endpoint.url, { method: 'GET' })
        .then(response => {
          const status = response.ok ? '✅' : '⚠️';
          addAdminNotification(`${status} ${endpoint.name}: ${response.status}`, response.ok ? 'success' : 'warning');
        })
        .catch(error => {
          addAdminNotification(`❌ ${endpoint.name}: Connection failed`, 'error');
        });
    }, index * 1000);
  });
}

function processPendingEmails() {
  const pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  
  if (pendingEmails.length === 0) {
    addAdminNotification('No pending emails to process', 'info');
    return;
  }
  
  addAdminNotification(`📧 Processing ${pendingEmails.length} pending emails...`, 'info');
  
  // In a real implementation, this would send emails via your email service
  // For now, we'll simulate processing and move them to a processed list
  const processedEmails = JSON.parse(localStorage.getItem('processedEmails') || '[]');
  
  pendingEmails.forEach(email => {
    email.processedAt = new Date().toISOString();
    email.status = 'processed';
    processedEmails.push(email);
  });
  
  localStorage.setItem('processedEmails', JSON.stringify(processedEmails));
  localStorage.setItem('pendingEmails', JSON.stringify([]));
  
  loadPendingEmails();
  addAdminNotification(`✅ ${pendingEmails.length} emails processed successfully`, 'success');
}

function processSingleEmail(index) {
  const pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  
  if (index >= 0 && index < pendingEmails.length) {
    const email = pendingEmails[index];
    
    // Move to processed
    const processedEmails = JSON.parse(localStorage.getItem('processedEmails') || '[]');
    email.processedAt = new Date().toISOString();
    email.status = 'processed';
    processedEmails.push(email);
    
    // Remove from pending
    pendingEmails.splice(index, 1);
    
    localStorage.setItem('processedEmails', JSON.stringify(processedEmails));
    localStorage.setItem('pendingEmails', JSON.stringify(pendingEmails));
    
    loadPendingEmails();
    addAdminNotification(`✅ Email processed for ${email.data.name || email.data.email}`, 'success');
  }
}

function deletePendingEmail(index) {
  const pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  
  if (index >= 0 && index < pendingEmails.length) {
    const email = pendingEmails[index];
    pendingEmails.splice(index, 1);
    localStorage.setItem('pendingEmails', JSON.stringify(pendingEmails));
    loadPendingEmails();
    addAdminNotification(`🗑️ Deleted pending email for ${email.data.name || email.data.email}`, 'warning');
  }
}

function viewEmailContent(index) {
  const pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  
  if (index >= 0 && index < pendingEmails.length) {
    const email = pendingEmails[index];
    
    const modalContent = `
      <div style="max-width: 600px;">
        <h4>📧 Email Preview</h4>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
          <p><strong>Type:</strong> ${email.type}</p>
          <p><strong>To:</strong> ${email.data.email || email.data.name}</p>
          <p><strong>Subject:</strong> ${email.preview.subject}</p>
          <p><strong>Timestamp:</strong> ${new Date(email.timestamp).toLocaleString()}</p>
        </div>
        <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
          <h5>Email Content:</h5>
          <pre style="white-space: pre-wrap; font-family: Arial, sans-serif;">${email.preview.body}</pre>
        </div>
        <div style="margin-top: 15px;">
          <button class="action-btn btn-success" onclick="processSingleEmail(${index}); closeModal();">✉️ Send This Email</button>
          <button class="action-btn btn-danger" onclick="deletePendingEmail(${index}); closeModal();">🗑️ Delete</button>
        </div>
      </div>
    `;
    
    openModal('Email Content Preview', modalContent);
  }
}

function testMobileLayout() {
  addAdminNotification('📱 Testing mobile layout...', 'info');
  updateDeviceInfo();
  
  // Simulate mobile view
  const currentWidth = window.innerWidth;
  if (currentWidth > 768) {
    addAdminNotification('💡 Consider testing on actual mobile device for best results', 'info');
  } else {
    addAdminNotification('✅ Mobile layout active', 'success');
  }
}

function testTouchInterface() {
  addAdminNotification('👆 Testing touch interface...', 'info');
  
  const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  
  if (touchSupport) {
    addAdminNotification('✅ Touch interface is supported', 'success');
    
    // Create a test touch element
    const testElement = document.createElement('div');
    testElement.style.cssText = `
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 100px; height: 100px; background: #667eea; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: bold; z-index: 10000; cursor: pointer;
    `;
    testElement.innerHTML = 'TAP ME';
    
    let tapped = false;
    const handleTouch = () => {
      if (!tapped) {
        tapped = true;
        testElement.style.background = '#28a745';
        testElement.innerHTML = 'SUCCESS!';
        setTimeout(() => {
          testElement.remove();
          addAdminNotification('✅ Touch test completed successfully', 'success');
        }, 1000);
      }
    };
    
    testElement.addEventListener('touchstart', handleTouch);
    testElement.addEventListener('click', handleTouch);
    document.body.appendChild(testElement);
    
    setTimeout(() => {
      if (!tapped && testElement.parentElement) {
        testElement.remove();
        addAdminNotification('⚠️ Touch test incomplete', 'warning');
      }
    }, 5000);
  } else {
    addAdminNotification('⚠️ Touch interface not detected', 'warning');
  }
}

function simulateMobileView() {
  addAdminNotification('📲 Simulating mobile view...', 'info');
  
  // Add mobile simulation class to body
  document.body.classList.toggle('mobile-simulation');
  
  // Add styles if not already added
  if (!document.getElementById('mobileSimStyles')) {
    const style = document.createElement('style');
    style.id = 'mobileSimStyles';
    style.textContent = `
      .mobile-simulation {
        max-width: 375px !important;
        margin: 0 auto !important;
        border: 2px solid #333 !important;
        border-radius: 25px !important;
      }
      .mobile-simulation .dashboard {
        padding: 10px !important;
      }
    `;
    document.head.appendChild(style);
  }
  
  const isSimulating = document.body.classList.contains('mobile-simulation');
  addAdminNotification(
    isSimulating ? '📱 Mobile view simulation enabled' : '💻 Mobile view simulation disabled',
    'info'
  );
}

function testFallbackSystems() {
  addAdminNotification('🧪 Testing fallback systems...', 'info');
  
  // Test email fallback
  const testEmailData = {
    name: 'Test User',
    email: 'test@example.com'
  };
  
  sendFallbackEmailNotification('welcome', testEmailData);
  addAdminNotification('✅ Email fallback system tested', 'success');
  
  // Test local storage backup
  try {
    const testData = { test: true, timestamp: new Date().toISOString() };
    localStorage.setItem('fallbackTest', JSON.stringify(testData));
    localStorage.removeItem('fallbackTest');
    addAdminNotification('✅ Local storage backup tested', 'success');
  } catch (error) {
    addAdminNotification('❌ Local storage backup failed', 'error');
  }
  
  // Test notification system
  setTimeout(() => {
    addAdminNotification('✅ Visual notification system tested', 'success');
  }, 1000);
}

function markAllNotificationsRead() {
  const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
  notifications.forEach(notification => notification.read = true);
  localStorage.setItem('adminNotifications', JSON.stringify(notifications));
  loadAdminNotifications();
  addAdminNotification('✅ All notifications marked as read', 'success');
}

function clearOldNotifications() {
  const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
  const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
  const filtered = notifications.filter(n => new Date(n.timestamp) > oneDayAgo);
  localStorage.setItem('adminNotifications', JSON.stringify(filtered));
  loadAdminNotifications();
  addAdminNotification(`🗑️ Cleared ${notifications.length - filtered.length} old notifications`, 'info');
}

function exportEmailQueue() {
  const pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  const processedEmails = JSON.parse(localStorage.getItem('processedEmails') || '[]');
  
  const exportData = {
    pendingEmails: pendingEmails,
    processedEmails: processedEmails,
    exportedAt: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `email-queue-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  addAdminNotification('💾 Email queue exported successfully', 'success');
}

function sendManualEmail() {
  const content = document.getElementById('manualEmailContent').value;
  const recipient = document.getElementById('manualEmailRecipient').value;
  const subject = document.getElementById('manualEmailSubject').value;
  
  if (!content || !recipient || !subject) {
    addAdminNotification('❌ Please fill in all manual email fields', 'error');
    return;
  }
  
  // In a real implementation, this would send via your email service
  // For now, we'll simulate and add to processed emails
  const manualEmail = {
    id: Date.now(),
    type: 'manual',
    data: { name: 'Manual', email: recipient },
    preview: { subject: subject, body: content },
    timestamp: new Date().toISOString(),
    processedAt: new Date().toISOString(),
    status: 'manual-sent'
  };
  
  const processedEmails = JSON.parse(localStorage.getItem('processedEmails') || '[]');
  processedEmails.push(manualEmail);
  localStorage.setItem('processedEmails', JSON.stringify(processedEmails));
  
  // Clear form
  document.getElementById('manualEmailContent').value = '';
  document.getElementById('manualEmailRecipient').value = '';
  document.getElementById('manualEmailSubject').value = '';
  
  addAdminNotification(`📤 Manual email sent to ${recipient}`, 'success');
}

// Include fallback email functions from other pages
function sendFallbackEmailNotification(emailType, data) {
  let pendingEmails = JSON.parse(localStorage.getItem('pendingEmails') || '[]');
  
  const emailRequest = {
    id: Date.now(),
    type: emailType,
    data: data,
    timestamp: new Date().toISOString(),
    status: 'pending',
    preview: generateEmailContent(emailType, data)
  };
  
  pendingEmails.push(emailRequest);
  localStorage.setItem('pendingEmails', JSON.stringify(pendingEmails));
  
  // Update UI if debug tab is active
  if (document.getElementById('debug').classList.contains('active')) {
    loadPendingEmails();
  }
  
  addAdminNotification(`📧 ${emailType} email queued for processing`, 'info');
}

function generateEmailContent(emailType, data) {
  switch(emailType) {
    case 'welcome':
      return {
        subject: 'Welcome to Cupcakes on the Avenue! 🧁',
        body: `Dear ${data.name},\n\nWelcome to Cupcakes on the Avenue! We're delighted to have you join our family of cupcake lovers.\n\nThank you for choosing Cupcakes on the Avenue!\n\nWith sweet regards,\nCupcakes on the Avenue Team`
      };
    case 'orderConfirmation':
      const items = data.orderData ? data.orderData.items.map(item => 
        `${item.name} x${item.quantity} - £${item.price}`
      ).join('\n') : 'Order details';
      return {
        subject: `Order Confirmation - ${data.orderData ? data.orderData.orderNumber : 'ORDER'} 🧁`,
        body: `Dear ${data.name},\n\nThank you for your order!\n\n${items}\n\nBest regards,\nCupcakes on the Avenue`
      };
    default:
      return { subject: 'Cupcakes on the Avenue Notification', body: 'Email content will be generated.' };
  }
}

// PWA Functionality
let deferredPrompt;
let swRegistration;

// Initialize PWA
document.addEventListener('DOMContentLoaded', () => {
  initializePWA();
});

function initializePWA() {
  // Hide loading screen after a delay
  setTimeout(() => {
    document.getElementById('appLoading').classList.add('hidden');
  }, 2000);
  
  // Register service worker
  if ('serviceWorker' in navigator) {
    registerServiceWorker();
  }
  
  // Setup connection monitoring
  setupConnectionMonitoring();
  
  // Setup pull-to-refresh
  setupPullToRefresh();
  
  // Setup install prompt
  setupInstallPrompt();
  
  // Setup app shortcuts
  setupAppShortcuts();
  
  // Initialize notifications
  setupNotifications();
}

function registerServiceWorker() {
  navigator.serviceWorker.register('/admin-sw.js')
    .then((registration) => {
      console.log('PWA: Service Worker registered', registration);
      swRegistration = registration;
      
      // Check for updates
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        if (newWorker) {
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateBanner();
            }
          });
        }
      });
      
      // Handle messages from service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'CACHE_UPDATED') {
          console.log('PWA: Cache updated');
        }
      });
    })
    .catch((error) => {
      console.error('PWA: Service Worker registration failed', error);
    });
}

function setupConnectionMonitoring() {
  const statusElement = document.getElementById('connectionStatus');
  
  function updateConnectionStatus() {
    if (navigator.onLine) {
      statusElement.textContent = '🟢 Online';
      statusElement.className = 'connection-status online';
    } else {
      statusElement.textContent = '🔴 Offline';
      statusElement.className = 'connection-status offline';
    }
  }
  
  window.addEventListener('online', () => {
    updateConnectionStatus();
    addAdminNotification('🌐 Connection restored', 'success');
    
    // Trigger background sync
    if (swRegistration && swRegistration.sync) {
      swRegistration.sync.register('background-sync-emails');
    }
  });
  
  window.addEventListener('offline', () => {
    updateConnectionStatus();
    addAdminNotification('⚠️ Working offline - changes will sync when online', 'warning');
  });
  
  updateConnectionStatus();
}

function setupPullToRefresh() {
  let startY = 0;
  let currentY = 0;
  let pulling = false;
  const pullToRefresh = document.getElementById('pullToRefresh');
  const threshold = 80;
  
  document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) {
      startY = e.touches[0].pageY;
      pulling = false;
    }
  });
  
  document.addEventListener('touchmove', (e) => {
    if (window.scrollY === 0 && startY !== 0) {
      currentY = e.touches[0].pageY;
      const pullDistance = currentY - startY;
      
      if (pullDistance > 10) {
        pulling = true;
        e.preventDefault();
        
        if (pullDistance > threshold) {
          pullToRefresh.classList.add('show');
          pullToRefresh.textContent = '🔄 Release to refresh';
        } else {
          pullToRefresh.textContent = '⬇️ Pull to refresh';
        }
      }
    }
  });
  
  document.addEventListener('touchend', () => {
    if (pulling) {
      pullToRefresh.classList.remove('show');
      const pullDistance = currentY - startY;
      
      if (pullDistance > threshold) {
        refreshApp();
      }
      
      pulling = false;
      startY = 0;
      currentY = 0;
    }
  });
}

function setupInstallPrompt() {
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install banner after a delay if not already installed
    setTimeout(() => {
      if (!window.matchMedia('(display-mode: standalone)').matches) {
        document.getElementById('installBanner').classList.add('show');
      }
    }, 5000);
  });
  
  window.addEventListener('appinstalled', () => {
    console.log('PWA: App installed');
    addAdminNotification('📱 App installed successfully!', 'success');
    document.getElementById('installBanner').classList.remove('show');
  });
}

function setupAppShortcuts() {
  // Handle deep linking from shortcuts
  const hash = window.location.hash.substring(1);
  if (hash && document.getElementById(hash)) {
    setTimeout(() => {
      switchTab(hash);
    }, 2500);
  }
}

function setupNotifications() {
  if ('Notification' in window && 'serviceWorker' in navigator) {
    // Request notification permission
    if (Notification.permission === 'default') {
      setTimeout(() => {
        Notification.requestPermission().then((permission) => {
          if (permission === 'granted') {
            addAdminNotification('🔔 Notifications enabled', 'success');
          }
        });
      }, 10000);
    }
  }
}

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log('PWA: User accepted install');
      } else {
        console.log('PWA: User dismissed install');
      }
      deferredPrompt = null;
    });
  }
  document.getElementById('installBanner').classList.remove('show');
}

function dismissInstall() {
  document.getElementById('installBanner').classList.remove('show');
  // Don't show again for this session
  sessionStorage.setItem('installDismissed', 'true');
}

function showUpdateBanner() {
  document.getElementById('appUpdateBanner').classList.add('show');
}

function updateApp() {
  if (swRegistration && swRegistration.waiting) {
    swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
    swRegistration.waiting.addEventListener('statechange', (e) => {
      if (e.target.state === 'activated') {
        window.location.reload();
      }
    });
  }
  document.getElementById('appUpdateBanner').classList.remove('show');
}

function dismissUpdate() {
  document.getElementById('appUpdateBanner').classList.remove('show');
}

function refreshApp() {
  addAdminNotification('🔄 Refreshing app...', 'info');
  
  // Refresh data
  if (currentUser) {
    loadDashboardData();
    
    // If debug tab is active, refresh debug data
    if (document.getElementById('debug').classList.contains('active')) {
      initializeDebugTab();
    }
  }
  
  setTimeout(() => {
    addAdminNotification('✅ App refreshed', 'success');
  }, 1000);
}

// Send app data to service worker for caching
function cacheAppData() {
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    const appData = {
      orders: orders,
      customers: customers,
      inventory: inventory,
      pendingEmails: JSON.parse(localStorage.getItem('pendingEmails') || '[]')
    };
    
    navigator.serviceWorker.controller.postMessage({
      type: 'CACHE_APP_DATA',
      data: appData
    });
  }
}

// Enhanced notification function for PWA
function sendPWANotification(title, body, actions = []) {
  if ('serviceWorker' in navigator && swRegistration) {
    swRegistration.showNotification(title, {
      body: body,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23667eea" rx="20"/><text x="50" y="65" font-size="50" text-anchor="middle" fill="white">🧁</text></svg>',
      badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23667eea" rx="20"/><text x="50" y="65" font-size="50" text-anchor="middle" fill="white">🧁</text></svg>',
      vibrate: [200, 100, 200],
      actions: actions,
      tag: 'admin-notification',
      requireInteraction: true
    });
  }
}

// Confirm data reset with double confirmation
function confirmResetAllData() {
  if (confirm('⚠️ WARNING: This will permanently delete ALL data including orders, inventory, customers, and activities. This action cannot be undone.\n\nAre you absolutely sure you want to continue?')) {
    if (confirm('🚨 FINAL CONFIRMATION: Type "DELETE" in the next prompt to confirm you want to reset all data to zero.')) {
      const userInput = prompt('Type "DELETE" to confirm (case sensitive):');
      if (userInput === 'DELETE') {
        resetAllAdminData();
        alert('✅ All data has been reset successfully. The page will reload.');
        location.reload();
      } else {
        alert('❌ Reset cancelled - incorrect confirmation text.');
      }
    }
  }
}

// Auto-save data periodically
setInterval(() => {
  if (currentUser && navigator.onLine) {
    cacheAppData();
  }
}, 60000); // Every minute
</script>

</body>
</html>