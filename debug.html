<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Account Test - Debug Mode</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #FF6B35 0%, #8B4513 100%);
  min-height: 100vh;
  color: #333;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 15px;
  padding: 20px;
}

.test-section {
  margin: 20px 0;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 10px;
}

.test-section h3 {
  color: #667eea;
  margin-bottom: 10px;
}

button {
  background: #667eea;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  margin: 5px;
}

button:hover {
  background: #5a67d8;
}

input {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  margin: 5px;
  width: 200px;
}

.log {
  background: #f5f5f5;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  font-family: monospace;
  max-height: 200px;
  overflow-y: auto;
}

.status {
  padding: 5px 10px;
  border-radius: 3px;
  margin: 5px 0;
  display: inline-block;
}

.success { background: #d4edda; color: #155724; }
.error { background: #f8d7da; color: #721c24; }
.warning { background: #fff3cd; color: #856404; }
</style>
</head>

<body>
<div class="container">
  <h1>üßÅ Account System Debug Tool</h1>
  <p>Use this page to test email functionality and customer account features</p>

  <!-- Full Diagnostic Testing -->
  <div class="test-section">
    <h3>üîç Full System Diagnostic</h3>
    <div>
      <button onclick="runFullDiagnostic()">üöÄ Run Complete Diagnostic</button>
      <button onclick="testBackendConnection()">üîå Test Backend Only</button>
    </div>
    <p style="font-size: 14px; color: #666; margin-top: 10px;">
      Tests all systems: mobile layout, backend connectivity, and email functionality
    </p>
  </div>

  <!-- Email Testing -->
  <div class="test-section">
    <h3>üìß Email Testing</h3>
    <div>
      <input type="email" id="testEmail" placeholder="Enter email address" value="test@example.com">
      <input type="text" id="testName" placeholder="Enter name" value="Test Customer">
      <br>
      <button onclick="testWelcomeEmail()">Test Welcome Email</button>
      <button onclick="testOrderEmail()">Test Order Confirmation</button>
      <button onclick="checkEmailConfig()">Check Email Backend</button>
    </div>
    <div id="emailLog" class="log"></div>
  </div>

  <!-- Customer Data Testing -->
  <div class="test-section">
    <h3>üë§ Customer Account Testing</h3>
    <div>
      <button onclick="loadTestData()">Load Test Customer Data</button>
      <button onclick="clearTestData()">Clear All Data</button>
      <button onclick="showStoredData()">Show Stored Data</button>
      <button onclick="testLogin()">Test Login (sarah.johnson@example.com / 1234)</button>
    </div>
    <div id="dataLog" class="log"></div>
  </div>

  <!-- Mobile Testing -->
  <div class="test-section">
    <h3>üì± Mobile Testing</h3>
    <div>
      <button onclick="testMobileLayout()">Test Mobile Layout</button>
      <button onclick="checkViewport()">Check Viewport</button>
      <button onclick="testTouch()">Test Touch Events</button>
    </div>
    <div id="mobileLog" class="log"></div>
  </div>

  <!-- Quick Account Access -->
  <div class="test-section">
    <h3>üîó Quick Links</h3>
    <div>
      <button onclick="window.open('/account.html', '_blank')">Open Account Page</button>
      <button onclick="window.open('/account-demo.html', '_blank')">Open Demo Page</button>
      <button onclick="window.open('/shop.html', '_blank')">Open Shop Page</button>
    </div>
  </div>
</div>

<script>
function log(section, message, type = 'info') {
  const logDiv = document.getElementById(section + 'Log');
  const timestamp = new Date().toLocaleTimeString();
  const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
  logDiv.innerHTML += `<div class="status ${className}">[${timestamp}] ${message}</div>`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

async function testWelcomeEmail() {
  const email = document.getElementById('testEmail').value;
  const name = document.getElementById('testName').value;
  
  if (!email || !name) {
    log('email', 'Please enter email and name', 'error');
    return;
  }

  log('email', `Testing welcome email to ${email}...`, 'info');
  
  try {
    const response = await fetch('https://sumup-backend-lemon.vercel.app/api/send-customer-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        emailType: 'welcome',
        customerData: { name, email }
      })
    });
    
    if (response.ok) {
      const result = await response.json();
      log('email', `‚úÖ Welcome email sent successfully: ${JSON.stringify(result)}`, 'success');
    } else {
      const error = await response.text();
      log('email', `‚ùå Welcome email failed (${response.status}): ${error}`, 'error');
    }
  } catch (error) {
    log('email', `‚ùå Network error: ${error.message}`, 'error');
  }
}

async function testOrderEmail() {
  const email = document.getElementById('testEmail').value;
  const name = document.getElementById('testName').value;
  
  if (!email || !name) {
    log('email', 'Please enter email and name', 'error');
    return;
  }

  log('email', `Testing order confirmation email to ${email}...`, 'info');
  
  try {
    const response = await fetch('https://sumup-backend-lemon.vercel.app/api/send-customer-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        emailType: 'orderConfirmation',
        customerData: { name, email },
        orderData: {
          orderNumber: 'TEST-001',
          items: [
            { name: 'Christmas Cake', quantity: 1, price: '45.00' },
            { name: 'Shortbread Delight', quantity: 2, price: '50.00' }
          ],
          total: '¬£95.00',
          deliveryMethod: 'Home Delivery',
          deliveryInfo: '123 Test Street on Monday, November 4th, 2025',
          date: 'Monday, November 4th, 2025',
          address: '123 Test Street, Highworth'
        }
      })
    });
    
    if (response.ok) {
      const result = await response.json();
      log('email', `‚úÖ Order email sent successfully: ${JSON.stringify(result)}`, 'success');
    } else {
      const error = await response.text();
      log('email', `‚ùå Order email failed (${response.status}): ${error}`, 'error');
    }
  } catch (error) {
    log('email', `‚ùå Network error: ${error.message}`, 'error');
  }
}

async function checkEmailConfig() {
  log('email', 'Checking email backend configuration...', 'info');
  
  try {
    const response = await fetch('https://sumup-backend-lemon.vercel.app/api/send-customer-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        emailType: 'test',
        customerData: { name: 'Test', email: 'test@test.com' }
      })
    });
    
    const responseText = await response.text();
    log('email', `Backend response (${response.status}): ${responseText}`, response.ok ? 'success' : 'error');
  } catch (error) {
    log('email', `‚ùå Cannot reach backend: ${error.message}`, 'error');
  }
}

function loadTestData() {
  const testCustomer = {
    name: "Sarah Johnson",
    email: "sarah.johnson@example.com", 
    phone: "1234",
    joinDate: "2025-11-01"
  };
  
  const testOrders = [
    {
      id: "WEB-001",
      email: "sarah.johnson@example.com",
      orderDate: "2025-11-01",
      deliveryDate: "2025-11-05", 
      status: "preparing",
      items: [
        { name: "Shortbread Delight", quantity: 2, price: 25.00 },
        { name: "Vanilla Cupcakes", quantity: 6, price: 18.00 }
      ],
      total: 48.00,
      deliveryMethod: "delivery",
      address: "123 Test Street, Highworth, SN6 7AB"
    }
  ];
  
  localStorage.setItem('webCustomers', JSON.stringify([testCustomer]));
  localStorage.setItem('shopOrders', JSON.stringify(testOrders));
  
  log('data', '‚úÖ Test customer and order data loaded', 'success');
  log('data', `Customer: ${testCustomer.name} (${testCustomer.email})`, 'info');
  log('data', `Orders: ${testOrders.length} test orders created`, 'info');
}

function clearTestData() {
  localStorage.removeItem('webCustomers');
  localStorage.removeItem('shopOrders');
  localStorage.removeItem('adminOrders');
  localStorage.removeItem('customerAccount');
  
  log('data', 'üóëÔ∏è All test data cleared', 'warning');
}

function showStoredData() {
  const customers = JSON.parse(localStorage.getItem('webCustomers') || '[]');
  const orders = JSON.parse(localStorage.getItem('shopOrders') || '[]');
  const account = JSON.parse(localStorage.getItem('customerAccount') || 'null');
  
  log('data', `üìä Stored Data Summary:`, 'info');
  log('data', `- Customers: ${customers.length}`, 'info');
  log('data', `- Orders: ${orders.length}`, 'info');
  log('data', `- Logged in: ${account ? account.name : 'None'}`, 'info');
  
  if (customers.length > 0) {
    log('data', `- Customer emails: ${customers.map(c => c.email).join(', ')}`, 'info');
  }
}

function testLogin() {
  log('data', 'Testing automatic login with test data...', 'info');
  
  const testCustomer = {
    name: "Sarah Johnson",
    email: "sarah.johnson@example.com",
    phone: "1234"
  };
  
  localStorage.setItem('customerAccount', JSON.stringify(testCustomer));
  log('data', '‚úÖ Test login data set. Now open the account page to test.', 'success');
}

function testMobileLayout() {
  const viewport = window.visualViewport || { width: window.innerWidth, height: window.innerHeight };
  log('mobile', `üì± Screen size: ${viewport.width} x ${viewport.height}`, 'info');
  log('mobile', `Device pixel ratio: ${window.devicePixelRatio}`, 'info');
  log('mobile', `User agent: ${navigator.userAgent}`, 'info');
  
  if (viewport.width <= 768) {
    log('mobile', '‚úÖ Mobile layout should be active', 'success');
  } else {
    log('mobile', '‚ö†Ô∏è Desktop layout active', 'warning');
  }
}

function checkViewport() {
  const meta = document.querySelector('meta[name="viewport"]');
  log('mobile', `Viewport meta: ${meta ? meta.content : 'Not found'}`, 'info');
  
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  log('mobile', `Touch device: ${isTouchDevice}`, 'info');
}

function testTouch() {
  log('mobile', 'Testing touch events...', 'info');
  
  if ('ontouchstart' in window) {
    log('mobile', '‚úÖ Touch events supported', 'success');
  } else {
    log('mobile', '‚ö†Ô∏è Touch events not supported', 'warning');
  }
  
  if (navigator.maxTouchPoints > 0) {
    log('mobile', `‚úÖ Max touch points: ${navigator.maxTouchPoints}`, 'success');
  }
}

function testBackendConnection() {
  log('email', 'üîÑ Testing backend connection...', 'info');
  
  const BACKEND_BASE = 'https://sumup-backend.vercel.app';
  
  // Test health check
  fetch(`${BACKEND_BASE}/api/index`)
    .then(response => {
      if (response.ok) {
        log('email', '‚úÖ Backend health check passed', 'success');
        // Test email API
        return fetch(`${BACKEND_BASE}/api/send-customer-email`, { method: 'POST' });
      } else {
        throw new Error(`Health check failed: ${response.status}`);
      }
    })
    .then(response => {
      log('email', `üìß Email API response: ${response.status}`, response.ok ? 'success' : 'warning');
    })
    .catch(error => {
      log('email', `‚ùå Backend connection failed: ${error.message}`, 'error');
      log('email', 'üí° Fallback email system will be used automatically', 'info');
    });
}

function runFullDiagnostic() {
  log('data', 'üîç Running full diagnostic test...', 'info');
  
  // Clear previous logs
  const containers = document.querySelectorAll('.log-container');
  containers.forEach(container => container.innerHTML = '');
  
  // Run all tests with delays for better UX
  setTimeout(() => testMobileLayout(), 100);
  setTimeout(() => checkViewport(), 200);
  setTimeout(() => testTouch(), 300);
  setTimeout(() => testBackendConnection(), 400);
  setTimeout(() => {
    log('data', 'üéâ Full diagnostic complete!', 'success');
    log('data', 'Check results in each section above.', 'info');
  }, 1000);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  log('email', 'Email testing ready', 'info');
  log('data', 'Customer data testing ready', 'info'); 
  log('mobile', 'Mobile testing ready', 'info');
  
  // Auto-check mobile layout
  testMobileLayout();
});
</script>

</body>
</html>